<!DOCTYPE html>
<html>
<head>
<title>Devel Documentation</title>
<meta name="generator" content="http://txt2tags.org">
<style>
body{background-color:#fff;color:#000;}
hr{background-color:#000;border:0;color:#000;}
hr.heavy{height:5px;}
hr.light{height:1px;}
img{border:0;display:block;}
img.right{margin:0 0 0 auto;}
img.center{border:0;margin:0 auto;}
table th,table td{padding:4px;}
.center,header{text-align:center;}
table.center {margin-left:auto; margin-right:auto;}
.right{text-align:right;}
.left{text-align:left;}
.tableborder,.tableborder td,.tableborder th{border:1px solid #000;}
.underline{text-decoration:underline;}
pre{background-color:#e6e6e6;padding:5px 3px}
</style>
</head>
<body>
<header>
<hgroup>
<h1>Devel Documentation</h1>
<h2>SaltOS 4.0 r2018</h2>
<h3>April 2025</h3>
</hgroup>
</header>
<article>

<nav>
<div class="body" id="body">

  <ul>
  <li><a href="#toc1">1. Introduction</a>
    <ul>
    <li><a href="#toc2">1.1. Advanced System Features</a>
    </li>
    <li><a href="#toc3">1.2. Project Structure</a>
    </li>
    <li><a href="#toc4">1.3. Code Directory</a>
    </li>
    <li><a href="#toc5">1.4. Data Directory</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc6">2. Backend (api/)</a>
    <ul>
    <li><a href="#toc7">2.1. Autoloaded Modules (`php/autoload/`)</a>
    </li>
    <li><a href="#toc8">2.2. Database Drivers (`php/database/`)</a>
    </li>
    <li><a href="#toc9">2.3. Libraries (`php/lib/`)</a>
    </li>
    <li><a href="#toc10">2.4. Action Modules (`php/action/`)</a>
    </li>
    <li><a href="#toc11">2.5. Other API Components</a>
    </li>
    <li><a href="#toc12">2.6. Configuration Files</a>
      <ul>
      <li><a href="#toc13">2.6.1. dbschema.xml</a>
      </li>
      <li><a href="#toc14">2.6.2. dbstatic.xml</a>
      </li>
      <li><a href="#toc15">2.6.3. config.xml</a>
      </li>
      <li><a href="#toc16">2.6.4. cron.xml</a>
      </li>
      <li><a href="#toc17">2.6.5. locale.xml</a>
      </li>
      <li><a href="#toc18">2.6.6. bs_theme.xml</a>
      </li>
      <li><a href="#toc19">2.6.7. css_theme.xml</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc20">2.7. API Access</a>
      <ul>
      <li><a href="#toc21">2.7.1. Web server access (Apache, Nginx, Cherokee)</a>
      </li>
      <li><a href="#toc22">2.7.2. Command-line access (CLI)</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc23">2.8. API Authentication</a>
      <ul>
      <li><a href="#toc24">2.8.1. HTTP Access</a>
      </li>
      <li><a href="#toc25">2.8.2. CLI Access</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc26">2.9. Token Lifecycle &amp; Session Security</a>
      <ul>
      <li><a href="#toc27">2.9.1. Token Binding</a>
      </li>
      <li><a href="#toc28">2.9.2. Expiration and Invalidation</a>
      </li>
      <li><a href="#toc29">2.9.3. CLI Considerations</a>
      </li>
      <li><a href="#toc30">2.9.4. Additional Protections</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc31">3. Frontend (web/)</a>
    <ul>
    <li><a href="#toc32">3.1. Logic (core.js and app.js)</a>
      <ul>
      <li><a href="#toc33">3.1.1. core.js Overview</a>
      </li>
      <li><a href="#toc34">3.1.2. app.js Overview</a>
      </li>
      <li><a href="#toc35">3.1.3. Integration and Responsibilities</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc36">3.2. Deployment</a>
    </li>
    <li><a href="#toc37">3.3. Offline Support (Service Worker)</a>
      <ul>
      <li><a href="#toc38">3.3.1. Main Features</a>
      </li>
      <li><a href="#toc39">3.3.2. Internal Structure</a>
      </li>
      <li><a href="#toc40">3.3.3. Debugging and Observability</a>
      </li>
      <li><a href="#toc41">3.3.4. Summary</a>
      </li>
      <li><a href="#toc42">3.3.5. Core Auth Module</a>
      </li>
      <li><a href="#toc43">3.3.6. Login Workflow</a>
      </li>
      <li><a href="#toc44">3.3.7. Overview of Modes</a>
      </li>
      <li><a href="#toc45">3.3.8. Build Process with Makefile</a>
      </li>
      <li><a href="#toc46">3.3.9. Web Directory Overview</a>
      </li>
      <li><a href="#toc47">3.3.10. Comparison Table</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc48">4. Application System</a>
    <ul>
    <li><a href="#toc49">4.1. YAML-based Apps</a>
      <ul>
      <li><a href="#toc50">4.1.1. tokenslog.yaml</a>
      </li>
      <li><a href="#toc51">4.1.2. configlog.yaml</a>
      </li>
      <li><a href="#toc52">4.1.3. types.yaml</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc53">4.2. XML-based Complex Apps</a>
      <ul>
      <li><a href="#toc54">4.2.1. customers.xml</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc55">4.3. Available Layouts Type1 To Type5</a>
    </li>
    <li><a href="#toc56">4.4. Data Model using dbschema.xml</a>
    </li>
    <li><a href="#toc57">4.5. Static Data using dbstatic.xml</a>
    </li>
    </ul>
  </li>
  <li><a href="#toc58">5. Makefile Overview</a>
    <ul>
    <li><a href="#toc59">5.1. Build Targets</a>
    </li>
    <li><a href="#toc60">5.2. Documentation</a>
    </li>
    <li><a href="#toc61">5.3. Testing</a>
    </li>
    <li><a href="#toc62">5.4. Environment Checks</a>
    </li>
    <li><a href="#toc63">5.5. Dependency Management</a>
    </li>
    <li><a href="#toc64">5.6. Code Statistics</a>
    </li>
    <li><a href="#toc65">5.7. System Setup</a>
    </li>
    <li><a href="#toc66">5.8. System Actions</a>
    </li>
    <li><a href="#toc67">5.9. System langs</a>
    </li>
    <li><a href="#toc68">5.10. Script Directory Overview</a>
    </li>
    </ul>
  </li>
  </ul>

</div>
</nav>
<div class="body" id="body">

<section id="toc1">
<h1>1. Introduction</h1>

<p>
SaltOS4 is a modular, extensible framework for building Rich Internet Applications (RIAs). It is designed for rapid development of dynamic, offline-capable applications using a clean separation between backend and frontend.
</p>
<p>
It is composed of:
</p>

<ul>
<li>A PHP backend (`api/`)
</li>
<li>A JavaScript frontend (`web/`)
</li>
<li>REST/JSON API with support for CLI execution
</li>
<li>Offline operation through a Service Worker proxy
</li>
<li>Declarative and dinamic app definitions via XML and/or YAML
</li>
<li>Shared templates and logic to reduce boilerplate
</li>
<li>Clean separation of frontend and backend
</li>
<li>Rapid development of apps with shared templates and logic
</li>
</ul>

<section id="toc2">
<h2>1.1. Advanced System Features</h2>

<p>
SaltOS4 includes two key functionalities that stand out for their utility and focus on traceability:
</p>

<ul>
<li>Version traceability of records: Each modification in application data generates a new version of the record, maintaining a complete change history, similar to version control systems like Subversion or Git.
</li>
<li>Data access logging: The system records who accessed a piece of data, from where, and in what context (e.g., if it was shown in a list or form). This provides full auditability of data usage and consultation.
</li>
</ul>

</section>
<section id="toc3">
<h2>1.2. Project Structure</h2>

<p>
The root directory of SaltOS4 is organized as follows:
</p>

<ul>
<li>`README.md`: Provides an overview and quick-start instructions for the project.
</li>
<li>`LICENSE.md`: Text of the open-source license under which SaltOS4 is released.
</li>
<li>`makefile`: Automates repetitive development tasks, such as generating documentation using the scripts in `scripts/`.
</li>
<li>`code/`: Contains the full source code of the system, split into backend (PHP) and frontend (JavaScript) modules.
</li>
<li>`docs/`: Documentation files written in `.t2t` format, including generated outputs (`.pdf`, `.html`) and the source files used to build them.
</li>
<li>`scripts/`: Collection of PHP utilities that extract documentation from code comments, produce `.t2t`, `.pdf`, or `.html` outputs and more...
</li>
<li>`ujest/`: JavaScript unit tests using Jest.
</li>
<li>`utest/`: PHP unit tests using PHPUnit.
</li>
</ul>

<p>
This structure keeps the system cleanly separated between source code, documentation, automation, and testing components.
</p>

</section>
<section id="toc4">
<h2>1.3. Code Directory</h2>

<p>
The `code/` directory contains the source code and runtime data of SaltOS4, structured as follows:
</p>

<ul>
<li>`api/`: Backend core written in PHP. Handles REST endpoints, internal services, and logic.
</li>
<li>`apps/`: Application modules. Each app includes its own backend, frontend, and configuration (PHP, JS, XML).
</li>
<li>`data/`: Stores persistent and temporary data generated by the system, such as files, images, downloaded or sent emails, cache, and temp files.
</li>
<li>`web/`: Frontend resources — primarily JavaScript and CSS — used in the browser interface.
</li>
</ul>

<p>
This structure supports both application logic and data flow across the SaltOS4 system.
</p>

</section>
<section id="toc5">
<h2>1.4. Data Directory</h2>

<p>
SaltOS4 stores runtime and persistent data under the `data/` directory. This folder contains several subdirectories used for caching, file storage, logging, and background task management. It is essential for the proper operation of the system.
</p>

<ul>
<li>`cache/`: Stores cached data to improve performance.
</li>
<li>`cron/`: Contains execution records and temporary files for scheduled tasks.
</li>
<li>`files/`: Persistent file storage used by applications.
</li>
<li>`inbox/`: Incoming data such as fetched emails.
</li>
<li>`logs/`: Application and system logs.
</li>
<li>`outbox/`: Outgoing data, such as email messages.
</li>
<li>`temp/`: Temporary files used during various operations.
</li>
<li>`trash/`: Items marked as deleted but not permanently removed.
</li>
<li>`upload/`: Staging area for newly uploaded files before they are processed.
</li>
</ul>

<p>
Make sure this directory is writable by the web server and CLI user.
</p>

</section>
</section>
<section id="toc6">
<h1>2. Backend (api/)</h1>

<p>
The backend is under the `api/` folder and contains four folders (autoload, database, lib and actions) to organize the code depending their usage and functionality.
</p>

<section id="toc7">
<h2>2.1. Autoloaded Modules (`php/autoload/`)</h2>

<p>
Core functions automatically loaded on each request:
</p>

<ul>
<li>`autoload/apps.php`: * Apps helper module
</li>
<li>`autoload/array.php`: * Array helper module
</li>
<li>`autoload/compat.php`: * Compatibility helper module
</li>
<li>`autoload/config.php`: * Config helper module
</li>
<li>`autoload/database.php`: * Database helper module
</li>
<li>`autoload/datetime.php`: * Datetime helper module
</li>
<li>`autoload/error.php`: * Error helper module
</li>
<li>`autoload/exec.php`: * Execution helper module
</li>
<li>`autoload/file.php`: * File utils helper module
</li>
<li>`autoload/getdata.php`: * Get data helper module
</li>
<li>`autoload/gettext.php`: * Gettext helper module
</li>
<li>`autoload/iniset.php`: * Iniset helper module
</li>
<li>`autoload/json.php`: * Json helper module
</li>
<li>`autoload/log.php`: * Log helper module
</li>
<li>`autoload/memory.php`: * Memory helper module
</li>
<li>`autoload/mime.php`: * Mime helper module
</li>
<li>`autoload/output.php`: * Output helper module
</li>
<li>`autoload/pcov.php`: * PCOV helper module
</li>
<li>`autoload/perms.php`: * Permissions helper module
</li>
<li>`autoload/random.php`: * Random helper module
</li>
<li>`autoload/semaphores.php`: * Semaphore helper module
</li>
<li>`autoload/server.php`: * Server helper module
</li>
<li>`autoload/sql.php`: * SQL utils helper module
</li>
<li>`autoload/strings.php`: * String utils helper module
</li>
<li>`autoload/system.php`: * System helper module
</li>
<li>`autoload/tokens.php`: * Tokens helper module
</li>
<li>`autoload/user.php`: * User helper module
</li>
<li>`autoload/version.php`: * Version helper module
</li>
<li>`autoload/xml2array.php`: * XML to Array helper module
</li>
<li>`autoload/yaml.php`: * Yaml helper module
</li>
<li>`autoload/zindex.php`: * Main execution module
</li>
</ul>

</section>
<section id="toc8">
<h2>2.2. Database Drivers (`php/database/`)</h2>

<p>
Supports:
</p>

<ul>
<li>`database/libsqlite.php`: * SQLite3 functions library
</li>
<li>`database/mysqli.php`: * MySQL improved driver
</li>
<li>`database/pdo_mssql.php`: * PDO MsSQL driver
</li>
<li>`database/pdo_mysql.php`: * PDO MySQL driver
</li>
<li>`database/pdo_sqlite.php`: * PDO SQLite driver
</li>
<li>`database/sqlite3.php`: * SQLite3 driver
</li>
</ul>

</section>
<section id="toc9">
<h2>2.3. Libraries (`php/lib/`)</h2>

<p>
Not autoloaded; provide extra functionality:
</p>

<ul>
<li>`lib/actions.php`: * Actions module
</li>
<li>`lib/array2xml.php`: * Array to XML helper module
</li>
<li>`lib/ascii.php`: * Make Table ASCII
</li>
<li>`lib/auth.php`: * Login functions
</li>
<li>`lib/barcode.php`: * Barcode helper module
</li>
<li>`lib/browser.php`: * Browser helper module
</li>
<li>`lib/captcha.php`: * Captcha helper module
</li>
<li>`lib/color.php`: * Color helper module
</li>
<li>`lib/control.php`: * Control helper module
</li>
<li>`lib/cron.php`: * Cron utils helper module
</li>
<li>`lib/dbschema.php`: * Database schema helper module
</li>
<li>`lib/depend.php`: * Dependencies feature
</li>
<li>`lib/export.php`: * Export helper module
</li>
<li>`lib/files.php`: * Files module
</li>
<li>`lib/gc.php`: * Garbage collector helper module
</li>
<li>`lib/gdlib.php`: * GD utils helper module
</li>
<li>`lib/geoip.php`: * GeoIP helper module
</li>
<li>`lib/help.php`: * Help feature
</li>
<li>`lib/import.php`: * Import file helper module
</li>
<li>`lib/indexing.php`: * Make index helper module
</li>
<li>`lib/log.php`: * Log helper module
</li>
<li>`lib/math.php`: * Math utils helper module
</li>
<li>`lib/notes.php`: * Notes module
</li>
<li>`lib/password.php`: * Password helper module
</li>
<li>`lib/pdf.php`: * PDF helper module
</li>
<li>`lib/push.php`: * Push utils helper module
</li>
<li>`lib/qrcode.php`: * QRCode helper module
</li>
<li>`lib/score.php`: * Score image helper module
</li>
<li>`lib/security.php`: * Security helper module
</li>
<li>`lib/setup.php`: * Setup helper module
</li>
<li>`lib/trash.php`: * Send file to trash
</li>
<li>`lib/unoconv.php`: * Unoconv library
</li>
<li>`lib/upload.php`: * Add upload file
</li>
<li>`lib/version.php`: * Version helper module
</li>
</ul>

</section>
<section id="toc10">
<h2>2.4. Action Modules (`php/action/`)</h2>

<p>
Handle concrete system actions (CLI-aware where needed):
</p>

<ul>
<li>`action/add.php`: * Add log action
</li>
<li>`action/app.php`: * Application action
</li>
<li>`action/auth.php`: * Authentication helper module
</li>
<li>`action/cron.php`: * Garbage Collector action
</li>
<li>`action/gc.php`: * Garbage Collector action
</li>
<li>`action/image.php`: * BarCode action
</li>
<li>`action/indexing.php`: * Make indexing action
</li>
<li>`action/integrity.php`: * Make indexing action
</li>
<li>`action/push.php`: * Garbage Collector action
</li>
<li>`action/setup.php`: * DB Schema action
</li>
<li>`action/upload.php`: * Add files action
</li>
</ul>

</section>
<section id="toc11">
<h2>2.5. Other API Components</h2>

<p>
This section lists complementary elements in the backend that support the main API logic.
</p>

<ul>
<li>`index.php`: Main API entry point. It loads required bootstrap files (`autoload`, `zindex.php`) and dispatches incoming REST or CLI requests.
</li>
<li>`img/`: Contains SaltOS4 logos and branding assets.
</li>
<li>`locale/`: Stores multilingual resources used for translations and documentation. Includes `.yaml` files for language mapping, and `.odt`/`.pdf` for external formats.
</li>
<li>`xml/`: Holds static configuration files (e.g. schema, themes, locales).
</li>
<li>`lib/`: Contains third-party or integrated libraries used across the backend logic. Includes:
  <ul>
  <li>`atkinson`, `gorrisans`: font support
  </li>
  <li>`browscap`: browser capability detection
  </li>
  <li>`edifact`: EDI message parsing
  </li>
  <li>`fpdi`: PDF manipulation and import
  </li>
  <li>`phpgeoip`: IP geolocation
  </li>
  <li>`phpspreadsheet`: spreadsheet creation and parsing
  </li>
  <li>`roundcube`, `tcpdf`, `wolfsoftware`, `yaml`: other protocol, rendering, and utility libraries
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc12">
<h2>2.6. Configuration Files</h2>

<p>
SaltOS4 relies on several XML configuration files to define system-wide behavior, themes, languages, scheduled tasks, and database initialization. These files are stored in the root configuration directories and are essential for proper system setup.
</p>

<section id="toc13">
<h3>2.6.1. dbschema.xml</h3>

<p>
Defines the database schema structure used across all applications. It lists all tables, their fields, types, primary keys, indexes, and relationships.
</p>

</section>
<section id="toc14">
<h3>2.6.2. dbstatic.xml</h3>

<p>
Populates static content in the database. This includes predefined record values required for the system to operate correctly (e.g., permission types, core options).
</p>

</section>
<section id="toc15">
<h3>2.6.3. config.xml</h3>

<p>
Contains global system configuration, such as paths, timezones, defaults, UI settings, and other bootstrap parameters.
</p>

</section>
<section id="toc16">
<h3>2.6.4. cron.xml</h3>

<p>
Specifies scheduled tasks and their timing. Each entry defines a script to be executed periodically, along with interval definitions and optional conditions.
</p>

</section>
<section id="toc17">
<h3>2.6.5. locale.xml</h3>

<p>
Defines available languages and translation mappings for the interface. Used by the frontend and backend to provide multi-language support.
</p>

</section>
<section id="toc18">
<h3>2.6.6. bs_theme.xml</h3>

<p>
Defines Bootstrap theme settings, including color schemes, spacing, and variables that adapt the interface visually.
</p>

</section>
<section id="toc19">
<h3>2.6.7. css_theme.xml</h3>

<p>
Defines custom CSS style variants used in the frontend. Enables additional visual personalization beyond Bootstrap presets.
</p>

</section>
</section>
<section id="toc20">
<h2>2.7. API Access</h2>

<p>
SaltOS4 supports access via HTTP or CLI.
</p>

<section id="toc21">
<h3>2.7.1. Web server access (Apache, Nginx, Cherokee)</h3>

<p>
The main idea of sending information to SaltOS is to use the latest technologies, to do it, we are using restful request
</p>

<ul>
<li>GET with REST:
  <ul>
  <li>An example request: `<a href="https://host/?/app/invoices/view/2">https://host/?/app/invoices/view/2</a>`
  </li>
  <li>`@rest/0` = app
  </li>
  <li>`@rest/1` = invoices
  </li>
  <li>`@rest/2` = view
  </li>
  <li>`@rest/3` = 2
  </li>
  </ul>
</li>
<li>POST with JSON:
  <ul>
  <li>An example request: `<a href="https://host/?/app/invoices/insert">https://host/?/app/invoices/insert</a>`
  </li>
  <li>Use `Content-Type: application/json`
  </li>
  <li>Body parsed into `@json/...`
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc22">
<h3>2.7.2. Command-line access (CLI)</h3>

<ul>
<li>`php api/index.php app/customers/view/100`
</li>
<li>`user=admin php api/index.php app/customers/view/100`
</li>
<li>`cat data.json | user=admin php app/customers/insert`
</li>
</ul>

</section>
</section>
<section id="toc23">
<h2>2.8. API Authentication</h2>

<p>
SaltOS4 implements token-based authentication for both HTTP and CLI access. The authentication logic is handled by `auth.php`, which delegates to utility functions in `php/lib/auth.php`. Tokens are validated based on IP address and user agent.
</p>
<p>
Supported authentication actions:
</p>

<ul>
<li>`auth/login`: Authenticates a user using `user` and `pass` (JSON fields). Returns a token and user metadata.
</li>
<li>`auth/check`: Validates the current token.
</li>
<li>`auth/logout`: Invalidates the current token and ends the session.
</li>
<li>`auth/update`: Changes the password of the currently authenticated user.
</li>
</ul>

<p>
Each request is handled in `api/php/action/auth.php`, which delegates to utility functions defined in `php/lib/auth.php`.
</p>
<p>
The token is associated with the client IP address and user-agent to prevent misuse. Internally, `current_token()` retrieves the token from the request and validates it against stored sessions.
</p>

<section id="toc24">
<h3>2.8.1. HTTP Access</h3>

<p>
Users authenticate by calling the `auth/login` endpoint with a JSON payload and receive a token in response. This token must be included in subsequent requests using the `Authorization` header.
</p>
<p>
Example of authenticating via `curl`:
</p>

<pre>
curl -X POST https://yourdomain/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"user":"admin", "pass":"secret"}'
</pre>

<p>
Once authenticated, subsequent requests must include the token using a header:
</p>

<pre>
curl https://yourdomain/api/app/yourapp/list \
    -H "Authorization: Bearer your-token-goes-here"
</pre>

<p>
The backend automatically links the token to the user and group using functions from `autoload/user.php`. Permissions are enforced using `autoload/perms.php`, which determines whether a user can perform a given action on a given application or record.
</p>

</section>
<section id="toc25">
<h3>2.8.2. CLI Access</h3>

<p>
Authentication also works from the command line using the same API structure. Credentials are provided as JSON via stdin, and the result is a token.
</p>
<p>
Example::
</p>

<pre>
echo '{"user":"admin","pass":"secret"}' | php index.php auth/login
</pre>

<p>
Subsequent authenticated requests use the token as an environment variable:
</p>

<pre>
token=your-token php index.php app/customers/list
</pre>

<p>
Alternatively, if the user executing the PHP script is the owner of the `index.php` file, the token is not required. You can specify the user directly:
</p>
<p>
Example::
</p>

<pre>
user=admin php index.php app/customers/list
</pre>

<p>
This shortcut is only allowed for the instance owner. Other system users must use token-based authentication to prevent privilege escalation.
</p>

</section>
</section>
<section id="toc26">
<h2>2.9. Token Lifecycle &amp; Session Security</h2>

<p>
SaltOS4 uses token-based authentication for both HTTP and CLI access. Beyond basic login/logout operations, the system enforces session integrity and security through token validation mechanisms.
</p>

<section id="toc27">
<h3>2.9.1. Token Binding</h3>

<p>
Each token is bound to the following client attributes:
</p>

<ul>
<li><strong>IP address</strong> (`remote_addr`)
</li>
<li><strong>User agent</strong> (`user_agent`)
</li>
</ul>

<p>
This ensures that a token cannot be reused from another location or browser, protecting against token theft and reuse attacks.
</p>

</section>
<section id="toc28">
<h3>2.9.2. Expiration and Invalidation</h3>

<p>
Tokens are subject to expiration based on system configuration. They may be invalidated:
</p>

  <ul>
  <li>After a certain period of inactivity
  </li>
  <li>On user logout
  </li>
  <li>When explicitly reset by administrators
  </li>
  <li>If the IP address or user agent changes
  </li>
  </ul>

<p>
Expired or invalid tokens are automatically purged during background cleanup tasks (`crontab_users()`).
</p>

</section>
<section id="toc29">
<h3>2.9.3. CLI Considerations</h3>

<p>
When executing scripts from the command line:
</p>

<ul>
<li>Tokens can be obtained via `auth/login` and passed as `token=...` in subsequent commands.
</li>
<li>If the script is executed by the <strong>owner of `index.php`</strong>, tokens can be bypassed by specifying `user=...` directly.
</li>
<li>This bypass is not allowed for other system users, providing a secure fallback that respects file ownership.
</li>
</ul>

</section>
<section id="toc30">
<h3>2.9.4. Additional Protections</h3>

<ul>
<li>All token operations are guarded by semaphores to prevent race conditions.
</li>
<li>The backend checks token validity on every request via `checktoken()` (web) or `current_token()` (CLI).
</li>
<li>Sessions are tightly coupled to server-side validation and cannot be spoofed via headers alone.
</li>
</ul>

<p>
These security measures collectively ensure that only valid users can perform actions and that token reuse or hijacking is effectively prevented.
</p>

</section>
</section>
</section>
<section id="toc31">
<h1>3. Frontend (web/)</h1>

<p>
Frontend is a JavaScript SPA in the `web/` folder.
</p>

<ul>
<li>`index.htm`: loads Bootstrap, SaltOS scripts
</li>
<li>`web/js/`: client-side modules
</li>
<li>`web/lib/`: JS libraries
</li>
</ul>

<p>
JavaScript Modules:
</p>

<ul>
<li>`app.js`: * Application helper module
</li>
<li>`auth.js`: * Authentication helper module
</li>
<li>`backup.js`: * Backup &amp; Autosave helper module
</li>
<li>`bootstrap.js`: * Bootstrap helper module
</li>
<li>`common.js`: * Common helper module
</li>
<li>`core.js`: * Core helper module
</li>
<li>`driver.js`: * Driver module
</li>
<li>`filter.js`: * Filter module
</li>
<li>`form.js`: * Form helper module
</li>
<li>`gettext.js`: * Gettext helper module
</li>
<li>`hash.js`: * Hash helper module
</li>
<li>`object.js`: * Object helper module
</li>
<li>`proxy.js`: * Proxy module
</li>
<li>`push.js`: * Push &amp; favicon helper module
</li>
<li>`storage.js`: * Token helper module
</li>
<li>`token.js`: * Token helper module
</li>
<li>`window.js`: * Window helper module
</li>
</ul>

<section id="toc32">
<h2>3.1. Logic (core.js and app.js)</h2>

<p>
SaltOS4's frontend architecture is built upon two central modules: `core.js` and `app.js`. Together, they form the foundation for most runtime behavior, enabling dynamic interaction with the backend and managing the user interface.
</p>

<section id="toc33">
<h3>3.1.1. core.js Overview</h3>

<p>
The file `core.js` contains low-level utility functions and system-wide features. It is responsible for:
</p>

<ul>
<li>Capturing and reporting JavaScript errors, including sourcemapped stack traces.
</li>
<li>Sending AJAX requests, abstracted through `saltos.core.ajax(...)`.
</li>
<li>Creating and manipulating HTML and DOM nodes (`saltos.core.html(...)`, `saltos.core.append(...)`).
</li>
<li>Managing configuration options and global parameters.
</li>
<li>Serving as a base for other frontend modules (like auth, filter, window, etc).
</li>
</ul>

<p>
This file acts as the technical backbone for the client-side logic.
</p>

</section>
<section id="toc34">
<h3>3.1.2. app.js Overview</h3>

<p>
The file `app.js` implements the high-level application layer. It builds on top of `core.js` and adds features related to UI interaction and view management:
</p>

<ul>
<li>Registers and manages application views and layouts.
</li>
<li>Handles modal dialogs, toast notifications, and main layout rendering.
</li>
<li>Processes hash-based navigation (`#app/xyz/...`) and dispatches actions.
</li>
<li>Manages event hooks (e.g., `saltos.app.login`, `saltos.app.ready`).
</li>
<li>Integrates layout types (`type1` to `type5`) through `saltos.driver`.
</li>
</ul>

<p>
It is also responsible for launching the application when loaded in the browser.
</p>

</section>
<section id="toc35">
<h3>3.1.3. Integration and Responsibilities</h3>

<ul>
<li>`core.js` provides shared functionality, DOM helpers, AJAX, and error reporting.
</li>
<li>`app.js` drives the user interface, manages state, and coordinates navigation.
</li>
<li>Modules like `auth.js`, `filter.js`, `form.js` and others rely on both core and app for foundational logic.
</li>
</ul>

<p>
These two modules form the base platform for all SaltOS4 frontend applications.
</p>

</section>
</section>
<section id="toc36">
<h2>3.2. Deployment</h2>

<p>
To use SaltOS4 from the browser:
</p>

<ul>
<li>Publish `web/`
</li>
<li>Create symbolic links inside `web/`:
  <ul>
  <li>`apps/` → application resources
  </li>
  <li>`api/` → backend
  </li>
  </ul>
</li>
<li>Inside `api/`, symbolic links to:
  <ul>
  <li>`data/` → file storage
  </li>
  <li>`apps/` → app definitions
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc37">
<h2>3.3. Offline Support (Service Worker)</h2>

<p>
SaltOS4 includes a service worker defined in `js/proxy.js` that transparently enables offline support and network optimization. It plays a key role in improving performance and user experience, even under poor connectivity conditions.
</p>

<section id="toc38">
<h3>3.3.1. Main Features</h3>

<ul>
<li>Intercepts all `fetch` requests and serves them from cache when offline.
</li>
<li>Queues write operations (e.g., POST) and synchronizes them when the network is restored.
</li>
<li>Integrates seamlessly with the core AJAX layer (`core.js`), requiring no changes in application logic.
</li>
<li>Logs operations (network, cache, queue, error) using visual debug tools.
</li>
<li>Handles smart caching and fallback strategies depending on the request type.
</li>
</ul>

</section>
<section id="toc39">
<h3>3.3.2. Internal Structure</h3>

<p>
The service worker (`js/proxy.js`) contains the following key components:
</p>

<ul>
<li><strong>`console_log(message)`</strong>:
  <ul>
  <li>Broadcasts messages to all connected clients using `postMessage`, since `console.log()` is often suppressed in service workers.
  </li>
  </ul>
</li>
<li><strong>`debug(action, url, type, duration, size)`</strong>:
  <ul>
  <li>Builds color-coded debug output showing the nature of the request (`network`, `cache`, `queue`, `error`), its duration, and response size.
  </li>
  </ul>
</li>
<li><strong>`fetch` event listener</strong>:
  <ul>
  <li>Intercepts all network requests.
  </li>
  <li>Determines behavior based on request method and headers.
  </li>
  <li>Responds from cache, fetches from the network, or queues operations depending on availability and context.
  </li>
  </ul>
</li>
<li><strong>`message` event listener</strong>:
  <ul>
  <li>Handles external control commands sent by the application. Supported messages include:
    <ul>
    <li>`resetCache`: clears the entire cache storage.
    </li>
    <li>`resetQueue`: clears the queue of pending offline operations.
    </li>
    <li>`stop`: unregisters the service worker.
    </li>
    <li>`hello`: returns a "hello" reply for testing communication.
    </li>
    <li>`sync`: processes all queued requests and tries to send them online.
    </li>
    </ul>
  </li>
  </ul>
</li>
</ul>

<p>
These capabilities allow external scripts to manage the state and behavior of the proxy dynamically.
</p>

</section>
<section id="toc40">
<h3>3.3.3. Debugging and Observability</h3>

<p>
To aid debugging:
</p>

<ul>
<li>All major proxy actions are logged with clear visual indicators.
</li>
<li>Logs are forwarded to client tabs for visibility, even if the browser suppresses SW console output.
</li>
<li>This makes the proxy easier to monitor during development.
</li>
</ul>

</section>
<section id="toc41">
<h3>3.3.4. Summary</h3>

<p>
SaltOS4’s service worker acts as a smart, low-level proxy that enables offline functionality and efficient request handling. It ensures smooth interaction with the backend while minimizing the impact of network failures or latency.
</p>
<p>
+Authentication++
</p>
<p>
SaltOS4 uses JavaScript modules to handle login and authentication on the client side. The core logic is implemented in `web/js/auth.js`, while the login form logic is defined in `apps/users/js/login.js`.
</p>

</section>
<section id="toc42">
<h3>3.3.5. Core Auth Module</h3>

<p>
The `saltos.authenticate` module provides these functions:
</p>

<ul>
<li>`authtoken(user, pass)`: Sends credentials to the backend (`auth/login`). If successful, stores the token using `saltos.token.set(...)`.
</li>
<li>`checktoken()`: Validates the current token by calling `auth/check`.
</li>
<li>`deauthtoken()`: Logs out the user and removes the token (`auth/logout`).
</li>
<li>`authupdate(old, new, renew)`: Changes the user's password (`auth/update`).
</li>
</ul>

<p>
These functions internally use `saltos.app.ajax(...)`, which wraps `saltos.core.ajax(...)` for simplified usage.
</p>

</section>
<section id="toc43">
<h3>3.3.6. Login Workflow</h3>

<p>
The `saltos.login.authenticate` function handles the login form:
</p>

<ul>
<li>Validates that required fields are filled.
</li>
<li>Retrieves `user` and `pass` from the form.
</li>
<li>Calls `saltos.authenticate.authtoken(...)`.
</li>
<li>On failure, shows an error with `saltos.app.toast(...)`.
</li>
<li>On success:
</li>
<li>Redirects to `app/dashboard` if login was accessed directly.
</li>
<li>Triggers the global event `saltos.app.login`.
</li>
</ul>

<p>
This flow enables seamless login via the web UI while leveraging the same token-based backend used for API and CLI access.
</p>
<p>
+Build System++
</p>
<p>
SaltOS4 provides two build modes for the frontend: production and development. These modes are designed to balance efficiency and ease of debugging, and they are automatically generated using the `make web` and `make devel` targets in the project’s `Makefile`.
</p>

</section>
<section id="toc44">
<h3>3.3.7. Overview of Modes</h3>

<ul>
<li><strong>Production Mode (`make web`)</strong>:
  <ul>
  <li>Combines and minifies all JavaScript into `index.js`.
  </li>
  <li>Combines the service worker proxy and MD5 loader into `proxy.js`.
  </li>
  <li>Generates a minified `index.htm` with `integrity` hashes and MD5-based cache busting.
  </li>
  <li>Loads minimal assets, optimized for performance and security.
  </li>
  </ul>
</li>
<li><strong>Development Mode (`make devel`)</strong>:
  <ul>
  <li>Loads all source files individually from the `js/` folder.
  </li>
  <li>Skips minification, hashing, and integrity checks.
  </li>
  <li>Generates an `index.htm` with expanded script references for direct debugging.
  </li>
  <li>`proxy.js` becomes a lightweight loader with `importScripts(...)`.
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc45">
<h3>3.3.8. Build Process with Makefile</h3>

<ul>
<li>`make web`:
  <ul>
  <li>Uses scripts such as `fixpath.php`, `md5sum.php`, `uglifyjs`, `sha384.php`.
  </li>
  <li>Populates `index.htm` based on the `web/htm/index.htm` template, inserting hashes and integrity attributes.
  </li>
  </ul>
</li>
<li>`make devel`:
  <ul>
  <li>Uses `debug.php` to create a loader that references unminified files directly.
  </li>
  <li>Generates a simplified `proxy.js` pointing to the original sources.
  </li>
  </ul>
</li>
</ul>

<p>
Both modes are based on the same HTML loader template found in `web/htm/index.htm`, which is dynamically populated depending on the mode.
</p>

</section>
<section id="toc46">
<h3>3.3.9. Web Directory Overview</h3>

<ul>
<li>`api/`: symlink to the backend API (`code/api`)
</li>
<li>`apps/`: symlink to application code (`code/apps`)
</li>
<li>`htm/`: loader templates for generating `index.htm` and `ping.htm`
</li>
<li>`img/`: interface images and logos
</li>
<li>`index.htm`: main entry point, minified in production, expanded in development
</li>
<li>`index.js`: combined JavaScript (production only)
</li>
<li>`index.js.map`: sourcemap for `index.js` (production only)
</li>
<li>`proxy.js`: combined service worker or loader depending on mode
</li>
<li>`proxy.js.map`: sourcemap (production only)
</li>
<li>`js/`: source JavaScript code
</li>
<li>`lib/`: third-party libraries
</li>
</ul>

</section>
<section id="toc47">
<h3>3.3.10. Comparison Table</h3>

<table class="tableborder">
<tr>
<td><strong>Feature</strong></td>
<td><strong>Production Mode (`make web`)</strong></td>
<td><strong>Development Mode (`make devel`)</strong></td>
</tr>
<tr>
<td>Main JS</td>
<td>Combined in `index.js`</td>
<td>Loaded as individual source files</td>
</tr>
<tr>
<td>Proxy</td>
<td>Minified `proxy.js`</td>
<td>Lightweight `importScripts(...)` loader</td>
</tr>
<tr>
<td>HTML Loader</td>
<td>Minified `index.htm` with `integrity`</td>
<td>Expanded `index.htm` with raw script tags</td>
</tr>
<tr>
<td>Integrity Check</td>
<td>Enabled (SRI hashes)</td>
<td>Disabled (empty `integrity` attributes)</td>
</tr>
<tr>
<td>Cache Busting</td>
<td>Enabled (MD5 hashes)</td>
<td>Disabled</td>
</tr>
<tr>
<td>Sourcemaps</td>
<td>Included for debugging</td>
<td>Uses original sources directly</td>
</tr>
<tr>
<td>Goal</td>
<td>Efficiency and security</td>
<td>Debugging and development flexibility</td>
</tr>
</table>

</section>
</section>
</section>
<section id="toc48">
<h1>4. Application System</h1>

<p>
Applications in SaltOS4 are modular, defined in folders under `apps/`.
</p>
<p>
Each folder may contain:
</p>

<ul>
<li>`xml/manifest.xml`: declares the apps
</li>
<li>`xml/*.xml` or `xml/*.yaml`: application definitions
</li>
<li>`php/`, `js/`, `locale/`: optional logic and translations
</li>
<li>`dbschema.xml`, `dbstatic.xml`: database structure and static content
</li>
</ul>

<section id="toc49">
<h2>4.1. YAML-based Apps</h2>

<p>
SaltOS4 allows simple applications to be defined using YAML. This format is ideal for CRUD-style interfaces with basic forms and lists. Below are real-world examples used in the system.
</p>

<section id="toc50">
<h3>4.1.1. tokenslog.yaml</h3>

<pre>
app: tokenslog
require: apps/common/php/default.php
template: apps/common/xml/default.xml
indent: true
screen: type2
list:
    # [id, type, label]
    - [user_id, select, User]
    - [created_at, text, Created]
    - [token, text, Token]
    - [active, boolean, Active]
form:
    # [id, type, label]
    - [active, switch, Active]
    - [user_id, select, User]
    - [created_at, datetime, Created]
    - [updated_at, datetime, Updated]
    - [remote_addr, text, Remote Addres]
    - [user_agent, text, User Agent]
    - [token, text, Token]
    - [expires_at, datetime, Expires]
select:
    # [id, table, optional field]
    - [user_id, tbl_users]
</pre>

</section>
<section id="toc51">
<h3>4.1.2. configlog.yaml</h3>

<pre>
app: configlog
require: apps/common/php/default.php
template: apps/common/xml/default.xml
indent: true
screen: type2
list:
    # [id, type, label]
    - [user_id, select, User]
    - [key, text, Key]
form:
    # [id, type, label]
    - [user_id, select, User]
    - [key, text, Key]
    - [val, codemirror, Value]
select:
    # [id, table, optional field]
    - [user_id, tbl_users]
attr:
    # field:
    #   attr: value
    key:
        required: true
        autofocus: true
    val:
        required: true
        mode: json
        indent: true
</pre>

</section>
<section id="toc52">
<h3>4.1.3. types.yaml</h3>

<pre>
app: types
require: apps/common/php/default.php
template: apps/common/xml/default.xml
indent: true
screen: type5
list:
    # [id, type, label]
    - [name, text, Name]
    - [description, text, Description]
    - [active, boolean, Active]
form:
    # [id, type, label]
    - [active, switch, Active]
    - [name, text, Name]
    - [description, textarea, Description]
attr:
    # field:
    #   attr: value
    name:
        required: true
        autofocus: true
    description:
        required: true
</pre>

<p>
These examples demonstrate the simplicity of defining apps in YAML.
</p>

</section>
</section>
<section id="toc53">
<h2>4.2. XML-based Complex Apps</h2>

<p>
SaltOS4 also allows full custom apps defined in XML, often used for more complex business logic and interface customization.
</p>

<section id="toc54">
<h3>4.2.1. customers.xml</h3>

<p>
The following is a small example illustrating the structure of an application XML file:
</p>

<pre>
&lt;main&gt;
  &lt;screen&gt;type5&lt;/screen&gt;
  &lt;title&gt;Customers&lt;/title&gt;
  &lt;navbar&gt;
    &lt;item id="list" icon="list"&gt;List&lt;/item&gt;
    &lt;item id="create" icon="plus"&gt;New&lt;/item&gt;
  &lt;/navbar&gt;
&lt;/main&gt;
.
.
.
</pre>

<p>
This file contains the follow important nodes:
</p>

<ul>
<li>`&lt;main&gt;`: Defines a call to app/customers/main that returns the screen type, literals, and the navbar specification
</li>
<li>`&lt;list default="true"&gt;`: Defines a call to app/customers/list that returns a cache load from app/customers/list/cache
</li>
<li>`&lt;list id="cache"&gt;`: Defines a call to app/customers/list/cache that returns the interface of a list screen
</li>
<li>`&lt;list id="data"&gt;`: Defines a call to app/customers/list/data that returns the data of a list
</li>
<li>`&lt;_form&gt;`: This defines a form, there is no way to access it externally, it is for internal use
</li>
<li>`&lt;_data require="php/lib/log.php" eval="true"&gt;`: This defines a data block of a detail view, not accessible externally, intended for internal use
</li>
<li>`&lt;create&gt;`: Defines a call to app/customers/create that returns a cache load from app/customers/create/cache
</li>
<li>`&lt;create id="cache"&gt;`: Defines a call to app/customers/create/cache that returns the interface of a creation screen
</li>
<li>`&lt;create id="insert"&gt;`: Defines a call to app/customers/insert that allows inserting a record and returns the status
</li>
<li>`&lt;view&gt;`: Defines a call to app/customers/view that returns a cache load from app/customers/view/cache
</li>
<li>`&lt;view id="cache"&gt;`: Defines a call to app/customers/view/cache that returns the interface of a creation screen
</li>
<li>`&lt;edit&gt;`: Defines a call to app/customers/edit that returns a cache load from app/customers/edit/cache
</li>
<li>`&lt;edit id="cache"&gt;`: Defines a call to app/customers/edit/cache that returns the interface of a creation screen
</li>
<li>`&lt;edit id="update"&gt;`: Defines a call to app/customers/update that allows updating a record and returns the status
</li>
<li>`&lt;delete&gt;`: Defines a call to app/customers/delete that allows deleting a record and returns the status
</li>
<li>`&lt;action id="xxx"&gt;`: Defines a call to app/customers/xxx that allows to execute the xxx action for this application
</li>
</ul>

</section>
</section>
<section id="toc55">
<h2>4.3. Available Layouts Type1 To Type5</h2>

<p>
The interface engine (driver.js) in SaltOS4 supports multiple layout types depending on the application’s needs:
</p>

<ul>
<li>type1: Simple layout with a single zone (#one). Each action opens a new view.
</li>
<li>type2: Two zones — #one for the list and #two for details and attachments.
</li>
<li>type3: Three zones — #one, #two, and #three — allowing all views at once.
</li>
<li>type4: Extends type1. Adds #two as a modal to show details while keeping #one as the main area.
</li>
<li>type5: Extends type2. Shows details in #two and uses #three as a modal for attachments.
</li>
</ul>

<p>
Mobile adaptation:
</p>
<p>
If an app is configured with type2, type3, type4 or type5 and the window.innerWidth is less than 1200 pixels, the system automatically switches to type1. This improves usability on mobile devices by simplifying the workflow and avoiding cluttered interfaces.
</p>

</section>
<section id="toc56">
<h2>4.4. Data Model using dbschema.xml</h2>

<p>
Each application can define its own database schema through a dbschema.xml file. This file declares the required tables and fields. In addition, there is a central file (api/xml/dbschema.xml) that contains the shared tables used system-wide:
</p>

<ul>
<li>tbl_apps, tbl_perms, tbl_users_apps_perms, tbl_groups_apps_perms: permission control per user and group.
</li>
<li>tbl_uploads: temporarily uploaded files not yet assigned to an app.
</li>
<li>tbl_cron: execution log for scheduled tasks.
</li>
<li>tbl_push: push notifications.
</li>
<li>tbl_trash: records of deleted files.
</li>
</ul>

<p>
Examples of dbschema.xml in real apps:
</p>

<ul>
<li>apps/emails/xml/dbschema.xml: defines tables for emails, accounts, and addresses.
</li>
<li>apps/customers/xml/dbschema.xml: structure for customers including fiscal and geographic data.
</li>
<li>apps/invoices/xml/dbschema.xml: invoice headers, line items, and due dates.
</li>
<li>apps/types/xml/dbschema.xml: generic system for type definitions.
</li>
</ul>

</section>
<section id="toc57">
<h2>4.5. Static Data using dbstatic.xml</h2>

<p>
The file `dbstatic.xml` defines static records that are inserted into the database during system initialization. These values are essential for SaltOS4 to operate correctly and include:
</p>

<ul>
<li>Default permissions and ownership levels
</li>
<li>Core user and group records
</li>
<li>Registered applications in the system
</li>
<li>Permission-to-application assignments
</li>
<li>Initial permission grants for the main user
</li>
</ul>

<p>
These static values are inserted during system initialization and are critical to bootstrapping SaltOS4 correctly. They are also used by the `make setup` and `make setupinstall` targets to preload essential entities.
</p>
<p>
Example from `api/xml/dbstatic.xml`:
</p>

<ul>
<li>Table `tbl_perms`: defines available permissions like `main`, `create`, `widget`, `action`, etc., with optional ownership levels (`user`, `group`, `all`).
</li>
<li>Other tables likely define rows for default users, groups, apps, or app-permission mappings, though they are not visible in the excerpt shown.
</li>
</ul>

<p>
Each `&lt;row&gt;` inside `&lt;table&gt;` specifies a record to insert, using attributes like `id`, `code`, `name`, `owner`, and `active`.
</p>
<p>
This static data ensures consistent behavior across installations and is critical to bootstrapping the system correctly.
</p>

</section>
</section>
<section id="toc58">
<h1>5. Makefile Overview</h1>

<p>
This `Makefile` automates building, testing, documentation, and setup tasks in SaltOS4.
</p>

<section id="toc59">
<h2>5.1. Build Targets</h2>

<p>
SaltOS4 includes several `make` targets to manage the build process for both production and development environments. These targets automate the generation of optimized assets, cleanup of temporary files, and preparation of debug-friendly output.
</p>

<ul>
<li>`make web`: Builds and minifies production assets:
  <ul>
  <li>Combines and compresses CSS/JS
  </li>
  <li>Uses `fixpath.php`, `md5sum.php`, `uglifyjs`, `minify`, `sha384.php`
  </li>
  <li>Handles app-specific JS from `apps/*/js/*.js`
  </li>
  <li>Generates the `proxy.js` script with source maps
  </li>
  </ul>
</li>
<li>`make devel`: Prepares a development environment with unminified assets using `debug.php`.
</li>
<li>`make clean`: Deletes generated files:
  <ul>
  <li>Minified JS, CSS, maps, HTML, `proxy.js`, and per-app compiled assets
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc60">
<h2>5.2. Documentation</h2>

<p>
The `make docs` target is used to automatically generate documentation for multiple source areas. It leverages PHP scripts to extract comments and convert `.t2t` files into both PDF and HTML formats.
</p>
<p>
You can control which documentation files are processed using the `file` parameter. If no value is passed, all sections are generated by default.
</p>
<p>
Examples:
</p>

<ul>
<li>`make docs` → generates everything
</li>
<li>`make docs file=api` → generates only API documentation
</li>
<li>`make docs file=api,web` → generates both API and web documentation
</li>
</ul>

<p>
Supported sections:
</p>

<ul>
<li>`api`: generates the backend doc `docs/api.t2t` from `code/api/php`
</li>
<li>`web`: generates the fronend doc `docs/web.t2t` from `code/web/js`
</li>
<li>`apps`: generates the applications doc `docs/apps.t2t` from `code/apps/*/php` and `code/apps/*/js`
</li>
<li>`utest`: generates the php unit test doc `docs/utest.t2t` from `utest/`
</li>
<li>`ujest`: generates the javascript unit test `docs/ujest.t2t` from `ujest/`
</li>
<li>`devel`: updates de developer manual `docs/devel.t2t` (version/date) and regenerates its output
</li>
</ul>

<p>
This logic is implemented using pattern matching via `findstring` in the Makefile, allowing comma-separated values to select multiple targets at once.
</p>

</section>
<section id="toc61">
<h2>5.3. Testing</h2>

<p>
SaltOS4 integrates various testing mechanisms to maintain code quality across both PHP and JavaScript components. The `make` system provides convenient commands for running static analysis, unit tests, and coverage reports. Below are the available targets:
</p>

<ul>
<li>`make test`: Runs:
  <ul>
  <li>`phpcs`, `php -l`, `phpstan` on PHP files
  </li>
  <li>`jscs`, `node -c` on JS files
  </li>
  <li>Accepts variable `file=...`, `file=all`, or none (uses SVN diff)
  </li>
  </ul>
</li>
<li>`make utest`: Runs PHPUnit with optional filtering by file
</li>
<li>`make ujest`: Runs JS tests with Jest:
  <ul>
  <li>Cleans diff snapshots and temp coverage
  </li>
  <li>Supports full or filtered test runs
  </li>
  <li>Generates coverage report
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc62">
<h2>5.4. Environment Checks</h2>

<p>
SaltOS4 includes a helper target to verify that the environment is correctly set up. This check ensures required directories, symbolic links, and external tools are available before running builds, tests, or development tasks.
</p>

<ul>
<li>`make check`: Verifies required folders and system commands:
  <ul>
  <li>Symbolic links: `api/data`, `web/apps`, etc.
  </li>
  <li>Commands: `php`, `node`, `jest`, `phpunit`, `uglifyjs`, `txt2tags`, etc.
  </li>
  </ul>
</li>
</ul>

</section>
<section id="toc63">
<h2>5.5. Dependency Management</h2>

<p>
`make libs` executes `scripts/checklibs.php`, which checks for new versions of required PHP and JavaScript libraries, as well as other external software used by the system. This mechanism helps monitor version updates and ensures that all dependencies remain current.
</p>
<p>
Libraries can be integrated through various methods depending on how they are distributed — for example:
</p>

<ul>
<li>Via `wget` from a direct URL
</li>
<li>Via `npm`
</li>
<li>Via Composer for PHP packages
</li>
</ul>

<p>
The monitoring is based on the file `checklibs.txt`, where each line defines how to retrieve and compare the current version of a library or tool.
</p>
<p>
Example line from `checklibs.txt`:
</p>

<pre>
phpmailer|https://github.com/PHPMailer/PHPMailer/tags.atom|&lt;title&gt;|PHRpdGxlPlBIUE1haWxlciA2LjkuMzwvdGl0bGU+
</pre>

<p>
As you can see, this line consists of four fields, using pipes (|) as separators:
</p>

<ul>
<li>The name of the item (library, command, etc.), used as an identifier
</li>
<li>The URL to fetch the latest version information (can be XML, JSON, or plain HTML)
</li>
<li>A regular expression pattern to match the relevant line that announces the latest version
</li>
<li>A base64-encoded string representing the last matched content, used to detect changes
</li>
</ul>

<p>
This tells `checklibs.php` to:
</p>

<ul>
<li>Retrieve the GitHub tags feed for PHPMailer in Atom (XML) format
</li>
<li>Match the line containing the version information using the regex
</li>
<li>Compare the base64-encoded result with the previously recorded one to determine if an update is available
</li>
</ul>

<p>
This system is useful for tracking updates manually without relying on automatic dependency managers.
</p>

</section>
<section id="toc64">
<h2>5.6. Code Statistics</h2>

<p>
`make cloc` uses `cloc` to count lines of code excluding minified and ignored files, you can see an example here:
</p>

<pre>
---------------------------------------------------------------------------
Language                    files         blank       comment          code
---------------------------------------------------------------------------
PHP                           302          3809         18565         23321
JavaScript                     44          1040          6596         10536
XML                            47           312          1258          4566
YAML                           15            14           355           450
Text                            4            13             0            93
Bourne Shell                    1             5             0            36
HTML                            1             2            24            15
JSON                            1             0             0            12
---------------------------------------------------------------------------
SUM:                          415          5195         26798         39029
---------------------------------------------------------------------------
</pre>

</section>
<section id="toc65">
<h2>5.7. System Setup</h2>

<p>
These targets initialize or reset the SaltOS4 environment, including database setup and cleanup of data directories. They allow switching between MariaDB and SQLite, and can be used to fully reconfigure the system during development or deployment.
</p>

<ul>
<li>`make setup`: Initializes SaltOS4 system
</li>
<li>`make setupmysql`: Sets up all applications using MariaDB
</li>
<li>`make setupsqlite`: Sets up all applications using SQLite
</li>
<li>`make setupinstall`: Combines cleaning + full MySQL + SQLite setup
</li>
<li>`make setupclean`: Cleans data directories and resets the database
</li>
</ul>

</section>
<section id="toc66">
<h2>5.8. System Actions</h2>

<p>
These targets trigger internal maintenance operations in SaltOS4, such as garbage collection, indexing, integrity validation, and scheduled task execution. They help keep the system optimized and consistent.
</p>

<ul>
<li>`make gc`: Launches garbage collection
</li>
<li>`make indexing`: Performs indexing operations
</li>
<li>`make integrity`: Runs integrity checks
</li>
<li>`make cron`: Executes scheduled tasks (cron)
</li>
</ul>

</section>
<section id="toc67">
<h2>5.9. System langs</h2>

<p>
This rule runs the `scripts/checklangs.py` script to validate the integrity of all translation files across languages and groups.
</p>
<p>
To run the integrity check, use:
</p>

<pre>
make langs
</pre>

<p>
This will:
</p>

<ul>
<li>Analyze all `manifest.xml`, `.xml`, `.yaml`, and `.js` files in every app group
</li>
<li>Load all `messages.yaml` files from `api/locale/` and `apps/&lt;group&gt;/locale/`
</li>
<li>Detect duplicate translation keys:
   <ul>
   <li>Within the same file
   </li>
   <li>Between the global and any app group
   </li>
   <li>Between two groups (only with `--strict`)
   </li>
   </ul>
</li>
<li>Report any overlapping definitions that may need cleanup
</li>
</ul>

<p>
To perform additional per-language analysis manually, you can call the script with options:
</p>

<ul>
<li>`--lang=&lt;lang&gt;`: language to check (e.g. `ca_ES`)
</li>
<li>`--filter=missing|present|missing_but_in_other_group`
</li>
<li>`--group=&lt;group&gt;`: restrict to a specific app group
</li>
<li>`--csv=&lt;file.csv&gt;`: export results to a CSV file
</li>
<li>`--strict`: detect duplicate keys across app groups
</li>
</ul>

<p>
Examples:
</p>
<p>
Validate global integrity across all languages:
</p>

<pre>
make langs
</pre>

<p>
Run language-specific analysis manually:
</p>

<pre>
python scripts/checklangs.py --lang ca_ES --group=crm --filter=missing
</pre>

<p>
Strict duplicate detection between groups:
</p>

<pre>
python scripts/checklangs.py --strict
</pre>

</section>
<section id="toc68">
<h2>5.10. Script Directory Overview</h2>

<p>
This section describes the purpose of each script and configuration file in the `scripts/` directory.
</p>
<p>
All descriptions below are based on the actual content of each file.
</p>

<ul>
<li>`checklangs.py`: Scans XML/YAML/JS files for translation keys and detects missing or duplicated strings across apps.
</li>
<li>`checklibs.php`: Validates the current versions of required libraries by parsing `checklibs.txt`, performing curl requests, and comparing base64-encoded version strings. Updates the file if needed.
</li>
<li>`checklibs.txt`: Contains a list of required libraries, with their URLs and expected version tags encoded in base64.
</li>
<li>`debug.php`: Generates a debug-friendly version of the frontend using `debug.php`.
</li>
<li>`fixpath.php`: Adjusts file paths in generated HTML/JS/CSS to match the deployment structure.
</li>
<li>`jest.config.js`: Configuration file for running JavaScript unit tests with Jest.
</li>
<li>`jest_coverage.php`: Processes Jest coverage reports and outputs them in a readable format.
</li>
<li>`jest_tester.php`: Parses the layout structure from `apps/tester/xml/tester.xml`, checks for duplicate widget tags, and exports the data as `/tmp/tester.json`.
</li>
<li>`jscs.json`: Defines JavaScript coding standards used by the JSCS code style checker.
</li>
<li>`make_bootswatch.php`: Cleans up Bootswatch CSS files by removing any external `@import` statements.
</li>
<li>`make_instance.sh`: Creates a new runnable SaltOS4 instance by linking `.htaccess`, preparing folders like `data/` and `tmp/`, and applying permissions.
</li>
<li>`makehtml.php`: Converts a `.t2t` documentation file into an HTML file using `txt2tags`.
</li>
<li>`maket2t.php`: Scans a source directory and extracts `/** ... */` comments from each file to generate a `.t2t` documentation file.
</li>
<li>`makepdf.php`: Converts a `.t2t` documentation file into a `.pdf` using LaTeX.
</li>
<li>`md5sum.php`: Generates an MD5 checksum of one or more files.
</li>
<li>`migrate_v3_to_v4.php`: Migrates a SaltOS system from version 3 to version 4, adapting data and file structure.
</li>
<li>`movelangs.py`: Moves selected translation keys from a group-specific messages.yaml to the global one without altering file structure.
</li>
<li>`phpcs.xml`: Configuration file for PHP_CodeSniffer to enforce PHP coding standards.
</li>
<li>`phpstan.neon`: Configuration file for PHPStan, specifying analysis rules and paths for static code analysis.
</li>
<li>`phpunit.xml`: Configuration file for PHPUnit, specifying test directories, filters, and bootstrap files.
</li>
<li>`sha384.php`: Calculates SHA-384 hashes for files to use in Subresource Integrity (SRI) attributes in HTML.
</li>
<li>`updatet2t.php`: Updates the second and third lines of a `.t2t` file (used to update the version and date of `devel.t2t`).
<p></p>
</li>
</ul>

</section>
</section>
</div>
<!-- html code generated by txt2tags 3.4 (http://txt2tags.org) -->
<!-- cmdline: txt2tags -\-toc -t html -i devel.t2t -o devel.html -->
</article></body></html>
