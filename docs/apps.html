<!DOCTYPE html>
<html>
<head>
<title>Applications Documentation</title>
<meta name="generator" content="http://txt2tags.org">
<style>
body{background-color:#fff;color:#000;}
hr{background-color:#000;border:0;color:#000;}
hr.heavy{height:5px;}
hr.light{height:1px;}
img{border:0;display:block;}
img.right{margin:0 0 0 auto;}
img.center{border:0;margin:0 auto;}
table th,table td{padding:4px;}
.center,header{text-align:center;}
table.center {margin-left:auto; margin-right:auto;}
.right{text-align:right;}
.left{text-align:left;}
.tableborder,.tableborder td,.tableborder th{border:1px solid #000;}
.underline{text-decoration:underline;}
pre{background-color:#e6e6e6;padding:5px 3px}
</style>
</head>
<body>
<header>
<hgroup>
<h1>Applications Documentation</h1>
<h2>SaltOS 4.0 r2018</h2>
<h3>April 2025</h3>
</hgroup>
</header>
<article>

<nav>
<div class="body" id="body">

  <ul>
  <li><a href="#toc1">1. Certs</a>
    <ul>
    <li><a href="#toc2">1.1. Certificate Management Functions</a>
      <ul>
      <li><a href="#toc3">1.1.1. List Certificates</a>
      </li>
      <li><a href="#toc4">1.1.2. Insert Certificates</a>
      </li>
      <li><a href="#toc5">1.1.3. Convert Certificate Hash to Nickname</a>
      </li>
      <li><a href="#toc6">1.1.4. Check Certificate Existence</a>
      </li>
      <li><a href="#toc7">1.1.5. View Certificate Information</a>
      </li>
      <li><a href="#toc8">1.1.6. Delete Certificate</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc9">1.2. Directory helper</a>
      <ul>
      <li><a href="#toc10">1.2.1. Passthru helper</a>
      </li>
      <li><a href="#toc11">1.2.2. Init nssdb repo</a>
      </li>
      <li><a href="#toc12">1.2.3. Create certificate</a>
      </li>
      <li><a href="#toc13">1.2.4. Add certificate</a>
      </li>
      <li><a href="#toc14">1.2.5. List certificates</a>
      </li>
      <li><a href="#toc15">1.2.6. Info of a certificate</a>
      </li>
      <li><a href="#toc16">1.2.7. Pdf signature</a>
      </li>
      <li><a href="#toc17">1.2.8. Remove certificate</a>
      </li>
      <li><a href="#toc18">1.2.9. Reset nssdb repo</a>
      </li>
      <li><a href="#toc19">1.2.10. Update pdf</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc20">2. Common</a>
    <ul>
    <li><a href="#toc21">2.1. Profile application</a>
      <ul>
      <li><a href="#toc22">2.1.1. Main object</a>
      </li>
      <li><a href="#toc23">2.1.2. Initialization of profile settings</a>
      </li>
      <li><a href="#toc24">2.1.3. Update authentication settings</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc25">2.2. Data Actions Merger</a>
      <ul>
      <li><a href="#toc26">2.2.1. Merge data with actions</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc27">2.3. Apps helper module</a>
      <ul>
      <li><a href="#toc28">2.3.1. Make app file</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc29">2.4. File management functions</a>
      <ul>
      <li><a href="#toc30">2.4.1. List files in the logs directory</a>
      </li>
      <li><a href="#toc31">2.4.2. Get the full path of a file</a>
      </li>
      <li><a href="#toc32">2.4.3. Check if a file exists</a>
      </li>
      <li><a href="#toc33">2.4.4. View the contents of a file</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc34">2.5. Matrix functions</a>
      <ul>
      <li><a href="#toc35">2.5.1. Create matrix for version data</a>
      </li>
      <li><a href="#toc36">2.5.2. Create matrix for log data</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc37">3. Crm</a>
    <ul>
    <li><a href="#toc38">3.1. Quotes application</a>
      <ul>
      <li><a href="#toc39">3.1.1. Main object</a>
      </li>
      <li><a href="#toc40">3.1.2. Initialize the quotes application</a>
      </li>
      <li><a href="#toc41">3.1.3. Calculate the dynamic width for each column in the "lines" table.</a>
      </li>
      <li><a href="#toc42">3.1.4. Define cell configuration for each column in the "lines" table.</a>
      </li>
      <li><a href="#toc43">3.1.5. Calculate the dynamic width for each column in the "taxes" table.</a>
      </li>
      <li><a href="#toc44">3.1.6. Define cell configuration for each column in the "taxes" table.</a>
      </li>
      <li><a href="#toc45">3.1.7. Calculate equal column widths for the "totals" table.</a>
      </li>
      <li><a href="#toc46">3.1.8. Define cell configuration for the "totals" table.</a>
      </li>
      <li><a href="#toc47">3.1.9. Handle and recalculate quote line totals and tax breakdowns after user edits.</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc48">3.2. Reverses the process of `make_matrix_data()` for the `quotes` app.</a>
      <ul>
      <li><a href="#toc49">3.2.1. unmake_matrix_data</a>
      </li>
      <li><a href="#toc50">3.2.2. Generates or completes quote and final quote metadata.</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc51">4. Dashboard</a>
    <ul>
    <li><a href="#toc52">4.1. Dashboard application</a>
      <ul>
      <li><a href="#toc53">4.1.1. Main object</a>
      </li>
      <li><a href="#toc54">4.1.2. Initialization of dashboard</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc55">4.2. Dashboard widgets application</a>
      <ul>
      <li><a href="#toc56">4.2.1. Main object</a>
      </li>
      <li><a href="#toc57">4.2.2. Initialization of dashboard widgets</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc58">4.3. Dashboard and navbar generation logic.</a>
      <ul>
      <li><a href="#toc59">4.3.1. Build the default dashboard layout with groups and application buttons.</a>
      </li>
      <li><a href="#toc60">4.3.2. Build a personalized dashboard layout based on user config.</a>
      </li>
      <li><a href="#toc61">4.3.3. Build the application menu for the navbar.</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc62">5. Emails</a>
    <ul>
    <li><a href="#toc63">5.1. Email application</a>
      <ul>
      <li><a href="#toc64">5.1.1. Driver emails object</a>
      </li>
      <li><a href="#toc65">5.1.2. Create email template</a>
      </li>
      <li><a href="#toc66">5.1.3. Initialization, open, and close handlers for emails</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc67">5.2. Email application</a>
      <ul>
      <li><a href="#toc68">5.2.1. Main object</a>
      </li>
      <li><a href="#toc69">5.2.2. Initialize the email application</a>
      </li>
      <li><a href="#toc70">5.2.3. Perform server-related actions for emails</a>
      </li>
      <li><a href="#toc71">5.2.4. Delete selected emails</a>
      </li>
      <li><a href="#toc72">5.2.5. Delete a single email</a>
      </li>
      <li><a href="#toc73">5.2.6. Send an email</a>
      </li>
      <li><a href="#toc74">5.2.7. Set email state</a>
      </li>
      <li><a href="#toc75">5.2.8. Add signature to email</a>
      </li>
      <li><a href="#toc76">5.2.9. View email source</a>
      </li>
      <li><a href="#toc77">5.2.10. Reply to an email</a>
      </li>
      <li><a href="#toc78">5.2.11. Reply to all recipients of an email</a>
      </li>
      <li><a href="#toc79">5.2.12. Forward an email</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc80">5.3. Email Query Builder</a>
      <ul>
      <li><a href="#toc81">5.3.1. Generate WHERE query for emails</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc82">5.4. Get email library</a>
      <ul>
      <li><a href="#toc83">5.4.1. Requires section</a>
      </li>
      <li><a href="#toc84">5.4.2. Defines section</a>
      </li>
      <li><a href="#toc85">5.4.3. Remove all body</a>
      </li>
      <li><a href="#toc86">5.4.4. Process message</a>
      </li>
      <li><a href="#toc87">5.4.5. Process plain html</a>
      </li>
      <li><a href="#toc88">5.4.6. Process file</a>
      </li>
      <li><a href="#toc89">5.4.7. Check permissions</a>
      </li>
      <li><a href="#toc90">5.4.8. Get GZ File</a>
      </li>
      <li><a href="#toc91">5.4.9. Get source</a>
      </li>
      <li><a href="#toc92">5.4.10. Mime decode protected</a>
      </li>
      <li><a href="#toc93">5.4.11. Get mime</a>
      </li>
      <li><a href="#toc94">5.4.12. Get Node</a>
      </li>
      <li><a href="#toc95">5.4.13. Get type</a>
      </li>
      <li><a href="#toc96">5.4.14. Get disposition</a>
      </li>
      <li><a href="#toc97">5.4.15. Get files</a>
      </li>
      <li><a href="#toc98">5.4.16. Get info</a>
      </li>
      <li><a href="#toc99">5.4.17. Fix string</a>
      </li>
      <li><a href="#toc100">5.4.18. Get text body</a>
      </li>
      <li><a href="#toc101">5.4.19. Get full body</a>
      </li>
      <li><a href="#toc102">5.4.20. Get cid</a>
      </li>
      <li><a href="#toc103">5.4.21. Insert</a>
      </li>
      <li><a href="#toc104">5.4.22. Update</a>
      </li>
      <li><a href="#toc105">5.4.23. Add bcc</a>
      </li>
      <li><a href="#toc106">5.4.24. Gzfile size</a>
      </li>
      <li><a href="#toc107">5.4.25. Get email body</a>
      </li>
      <li><a href="#toc108">5.4.26. Generate formatted email header information</a>
      </li>
      <li><a href="#toc109">5.4.27. Extract and format the body of an email</a>
      </li>
      <li><a href="#toc110">5.4.28. Get email source</a>
      </li>
      <li><a href="#toc111">5.4.29. Get email files</a>
      </li>
      <li><a href="#toc112">5.4.30. Get cid</a>
      </li>
      <li><a href="#toc113">5.4.31. Is outbox</a>
      </li>
      <li><a href="#toc114">5.4.32. Server</a>
      </li>
      <li><a href="#toc115">5.4.33. Delete</a>
      </li>
      <li><a href="#toc116">5.4.34. Get viewpdf</a>
      </li>
      <li><a href="#toc117">5.4.35. Get download</a>
      </li>
      <li><a href="#toc118">5.4.36. Update email states</a>
      </li>
      <li><a href="#toc119">5.4.37. Generate PDF from emails</a>
      </li>
      <li><a href="#toc120">5.4.38. Generate iframe content with secure policies</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc121">5.5. Html helper module</a>
      <ul>
      <li><a href="#toc122">5.5.1. Defines section</a>
      </li>
      <li><a href="#toc123">5.5.2. Remove Script Tag</a>
      </li>
      <li><a href="#toc124">5.5.3. Remove Style Tag</a>
      </li>
      <li><a href="#toc125">5.5.4. Remove Comment Tag</a>
      </li>
      <li><a href="#toc126">5.5.5. Remove Meta Tag</a>
      </li>
      <li><a href="#toc127">5.5.6. Remove Link Tag</a>
      </li>
      <li><a href="#toc128">5.5.7. Inline Img Tag</a>
      </li>
      <li><a href="#toc129">5.5.8. Inline Img Style</a>
      </li>
      <li><a href="#toc130">5.5.9. Inline Img Background</a>
      </li>
      <li><a href="#toc131">5.5.10. Inline Image Helper</a>
      </li>
      <li><a href="#toc132">5.5.11. Extract Inline Images from Tags</a>
      </li>
      <li><a href="#toc133">5.5.12. Extract Inline Images from Styles</a>
      </li>
      <li><a href="#toc134">5.5.13. Extract Inline Images from Backgrounds</a>
      </li>
      <li><a href="#toc135">5.5.14. Fix Image Tags</a>
      </li>
      <li><a href="#toc136">5.5.15. Fix Image Styles</a>
      </li>
      <li><a href="#toc137">5.5.16. Fix Image Backgrounds</a>
      </li>
      <li><a href="#toc138">5.5.17. Fix Base64-Encoded Files</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc139">5.6. Make indexing action</a>
    </li>
    <li><a href="#toc140">5.7. Send email library</a>
      <ul>
      <li><a href="#toc141">5.7.1. Used libraries</a>
      </li>
      <li><a href="#toc142">5.7.2. Sendmail</a>
      </li>
      <li><a href="#toc143">5.7.3. Debugoutput helper</a>
      </li>
      <li><a href="#toc144">5.7.4. Parser</a>
      </li>
      <li><a href="#toc145">5.7.5. Message Id</a>
      </li>
      <li><a href="#toc146">5.7.6. Eml saver</a>
      </li>
      <li><a href="#toc147">5.7.7. Obj saver</a>
      </li>
      <li><a href="#toc148">5.7.8. Prepare email for sending</a>
      </li>
      <li><a href="#toc149">5.7.9. Perform email sending action</a>
      </li>
      <li><a href="#toc150">5.7.10. Send queued emails from the server</a>
      </li>
      <li><a href="#toc151">5.7.11. Retrieve email attachments</a>
      </li>
      <li><a href="#toc152">5.7.12. Update email signature, CC, and encryption state</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc153">6. Sales</a>
    <ul>
    <li><a href="#toc154">6.1. Invoices application</a>
      <ul>
      <li><a href="#toc155">6.1.1. Main object</a>
      </li>
      <li><a href="#toc156">6.1.2. Initialize the invoices application</a>
      </li>
      <li><a href="#toc157">6.1.3. Calculate the dynamic width for each column in the "lines" table.</a>
      </li>
      <li><a href="#toc158">6.1.4. Define cell configuration for each column in the "lines" table.</a>
      </li>
      <li><a href="#toc159">6.1.5. Calculate the dynamic width for each column in the "taxes" table.</a>
      </li>
      <li><a href="#toc160">6.1.6. Define cell configuration for each column in the "taxes" table.</a>
      </li>
      <li><a href="#toc161">6.1.7. Calculate equal column widths for the "totals" table.</a>
      </li>
      <li><a href="#toc162">6.1.8. Define cell configuration for the "totals" table.</a>
      </li>
      <li><a href="#toc163">6.1.9. Handle and recalculate invoice line totals and tax breakdowns after user edits.</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc164">6.2. ChartJS widgets for invoices</a>
      <ul>
      <li><a href="#toc165">6.2.1. compute_invoice_total_by_day</a>
      </li>
      <li><a href="#toc166">6.2.2. compute_invoice_avg_by_day</a>
      </li>
      <li><a href="#toc167">6.2.3. compute_top5_customers_by_total</a>
      </li>
      <li><a href="#toc168">6.2.4. compute_invoice_paid_vs_pending</a>
      </li>
      <li><a href="#toc169">6.2.5. compute_invoice_avg_days_to_pay</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc170">6.3. Reverses the process of `make_matrix_data()` for the `invoices` app.</a>
      <ul>
      <li><a href="#toc171">6.3.1. unmake_matrix_data</a>
      </li>
      <li><a href="#toc172">6.3.2. Generates or completes proforma and final invoice metadata.</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc173">7. Tester</a>
    <ul>
    <li><a href="#toc174">7.1. Tester application</a>
      <ul>
      <li><a href="#toc175">7.1.1. Tester object</a>
      </li>
      <li><a href="#toc176">7.1.2. Campo 8: Alert functionality</a>
      </li>
      <li><a href="#toc177">7.1.3. Campo 9: Modal functionality</a>
      </li>
      <li><a href="#toc178">7.1.4. Campo 10: Offcanvas functionality</a>
      </li>
      <li><a href="#toc179">7.1.5. Campo 11: Toast functionality</a>
      </li>
      <li><a href="#toc180">7.1.6. Campo 22: Open statistics page</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  <li><a href="#toc181">8. Users</a>
    <ul>
    <li><a href="#toc182">8.1. Login application</a>
      <ul>
      <li><a href="#toc183">8.1.1. Main object</a>
      </li>
      <li><a href="#toc184">8.1.2. Authenticate login function</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc185">8.2. Days functions</a>
      <ul>
      <li><a href="#toc186">8.2.1. Days to bin</a>
      </li>
      <li><a href="#toc187">8.2.2. Bin to days</a>
      </li>
      <li><a href="#toc188">8.2.3. Fix for days</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc189">8.3. Groups functions</a>
      <ul>
      <li><a href="#toc190">8.3.1. Insert group action</a>
      </li>
      <li><a href="#toc191">8.3.2. Update group action</a>
      </li>
      <li><a href="#toc192">8.3.3. Delete group action</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc193">8.4. Matrix functions</a>
      <ul>
      <li><a href="#toc194">8.4.1. Create matrix data</a>
      </li>
      <li><a href="#toc195">8.4.2. Create matrix cells</a>
      </li>
      <li><a href="#toc196">8.4.3. Unmake matrix data</a>
      </li>
      <li><a href="#toc197">8.4.4. Generate matrix permissions</a>
      </li>
      </ul>
    </li>
    <li><a href="#toc198">8.5. Users functions</a>
      <ul>
      <li><a href="#toc199">8.5.1. Insert user action</a>
      </li>
      <li><a href="#toc200">8.5.2. Update user action</a>
      </li>
      <li><a href="#toc201">8.5.3. Delete user action</a>
      </li>
      </ul>
    </li>
    </ul>
  </li>
  </ul>

</div>
</nav>
<div class="body" id="body">

<section id="toc1">
<h1>1. Certs</h1>

<section id="toc2">
<h2>1.1. Certificate Management Functions</h2>

<pre>
apps/certs/php/certs.php
</pre>

<p>
This file contains the main functions for managing certificates, including listing,
inserting, checking, viewing, and deleting certificates from the NSS database.
</p>

<section id="toc3">
<h3>1.1.1. List Certificates</h3>

<pre>
function __certs_list($search, $offset, $limit)
</pre>

<p>
This function retrieves a list of certificates from the NSS database, applies search filters,
and paginates the results based on offset and limit parameters.
</p>

<ul>
<li>@search =&gt; Search term or query to filter certificates.
</li>
<li>@offset =&gt; Offset for pagination.
</li>
<li>@limit  =&gt; Maximum number of certificates to retrieve.
</li>
</ul>

<p>
Return the list of certificates with their ID and name.
</p>

</section>
<section id="toc4">
<h3>1.1.2. Insert Certificates</h3>

<pre>
function __certs_insert($json)
</pre>

<p>
This function inserts certificates into the NSS database. It validates the uploaded files,
processes them, and handles errors if the import is unsuccessful.
</p>

<ul>
<li>@json =&gt; JSON object containing the certificate files and their details.
</li>
</ul>

<p>
Return the status and message of the operation.
</p>

</section>
<section id="toc5">
<h3>1.1.3. Convert Certificate Hash to Nickname</h3>

<pre>
function __certs_hash2nick($hash)
</pre>

<p>
This function maps a certificate hash to its corresponding nickname in the NSS database.
</p>

<ul>
<li>@hash =&gt; MD5 hash of the certificate nickname.
</li>
</ul>

<p>
Return the nickname of the certificate, or an empty string if not found.
</p>

</section>
<section id="toc6">
<h3>1.1.4. Check Certificate Existence</h3>

<pre>
function __certs_check($hash)
</pre>

<p>
This function checks if a certificate with the given hash exists in the NSS database.
</p>

<ul>
<li>@hash =&gt; MD5 hash of the certificate nickname.
</li>
</ul>

<p>
Return true if the certificate exists, false otherwise.
</p>

</section>
<section id="toc7">
<h3>1.1.5. View Certificate Information</h3>

<pre>
function __certs_view($hash)
</pre>

<p>
This function retrieves detailed information about a certificate using its hash.
</p>

<ul>
<li>@hash =&gt; MD5 hash of the certificate nickname.
</li>
</ul>

<p>
Return the status, nickname, and detailed information of the certificate.
</p>

</section>
<section id="toc8">
<h3>1.1.6. Delete Certificate</h3>

<pre>
function __certs_delete($hash)
</pre>

<p>
This function removes a certificate from the NSS database using its hash.
</p>

<ul>
<li>@hash =&gt; MD5 hash of the certificate nickname.
</li>
</ul>

<p>
Return the status of the delete operation.
</p>

</section>
</section>
<section id="toc9">
<h2>1.2. Directory helper</h2>

<pre>
apps/certs/php/nssdb.php
</pre>

<p>
This function returns the nssdb directory used by all functions
</p>

<section id="toc10">
<h3>1.2.1. Passthru helper</h3>

<pre>
function __nssdb_passthru_helper($cmd)
</pre>

<p>
This function uses the ob_passthru and improve the output
</p>

<ul>
<li>@cmd =&gt; command line to be executed
</li>
</ul>

</section>
<section id="toc11">
<h3>1.2.2. Init nssdb repo</h3>

<pre>
function __nssdb_init()
</pre>

<p>
This function tries to initialize the nssdb component with an empty repo
</p>

</section>
<section id="toc12">
<h3>1.2.3. Create certificate</h3>

<pre>
function __nssdb_create($outfile, $outpass, $subject = '', $name = '')
</pre>

<p>
This function create a dummy self signed certificate intended to be used in
test cases
</p>
<p>
$outfile =&gt; the p12 file
$outpass =&gt; the password used by the p12 file
</p>

</section>
<section id="toc13">
<h3>1.2.4. Add certificate</h3>

<pre>
function __nssdb_add($file, $pass)
</pre>

<p>
This function adds the p12 file that must contains a valid certificate to the
nssdb repo using the pass if needed
</p>

<ul>
<li>@file =&gt; the p12 file
</li>
<li>@pass =&gt; the p12 password
</li>
</ul>

</section>
<section id="toc14">
<h3>1.2.5. List certificates</h3>

<pre>
function __nssdb_list()
</pre>

<p>
This function returns the list of valid nicks that you can use with pdfsig
</p>

</section>
<section id="toc15">
<h3>1.2.6. Info of a certificate</h3>

<pre>
function __nssdb_info($nick, $shortnames = false)
</pre>

<p>
This function returns the info of the nick certificate of the nssdb repo
</p>

<ul>
<li>@nick =&gt; the desired nick used to retrieve info
</li>
</ul>

</section>
<section id="toc16">
<h3>1.2.7. Pdf signature</h3>

<pre>
function __nssdb_pdfsig($nick, $input, $output)
</pre>

<p>
This function uses the pdfsig to add the signature to the pdf using the nick
certificate of the nssdb repo
</p>

<ul>
<li>@nick   =&gt; the desired nick used to sign de pdf
</li>
<li>@input  =&gt; the desired input file that you want to sign
</li>
<li>@output =&gt; the signed pdf file
</li>
</ul>

</section>
<section id="toc17">
<h3>1.2.8. Remove certificate</h3>

<pre>
function __nssdb_remove($nick)
</pre>

<p>
This function remove the certificate from the nssdb repo indentified by nick
</p>

<ul>
<li>@nick =&gt; the desired nick that you want to remove
</li>
</ul>

</section>
<section id="toc18">
<h3>1.2.9. Reset nssdb repo</h3>

<pre>
function __nssdb_reset()
</pre>

<p>
This function removes the nssdb repo, is the inverted of the init function
</p>

</section>
<section id="toc19">
<h3>1.2.10. Update pdf</h3>

<pre>
function __nssdb_update($nick, $input)
</pre>

<p>
This function creates a new pdf document using input as source and adding to
each page a new box with the important information about the certificate used
in the signature process
</p>

<ul>
<li>@nick  =&gt; the desired nick used to sign de pdf
</li>
<li>@input =&gt; the desired input pdf file where you want to add the cert info
</li>
</ul>

</section>
</section>
</section>
<section id="toc20">
<h1>2. Common</h1>

<section id="toc21">
<h2>2.1. Profile application</h2>

<pre>
apps/common/js/profile.js
</pre>

<p>
This application implements the typical features associated with user profiles,
such as managing themes, language settings, and authentication updates.
</p>

<section id="toc22">
<h3>2.1.1. Main object</h3>

<pre>
saltos.profile = {};
</pre>

<p>
Contains all the logic and code for the SaltOS framework related to the profile application.
</p>

</section>
<section id="toc23">
<h3>2.1.2. Initialization of profile settings</h3>

<pre>
saltos.profile.init = arg
</pre>

<p>
This method initializes the profile settings by setting the current Bootstrap theme,
custom CSS theme, and language preferences in the respective input fields.
</p>

</section>
<section id="toc24">
<h3>2.1.3. Update authentication settings</h3>

<pre>
saltos.profile.authupdate = ()
</pre>

<p>
This method restores the previous state of the application if necessary,
validates required fields, and then updates the authentication credentials
using the provided old password, new password, and its confirmation.
</p>

</section>
</section>
<section id="toc25">
<h2>2.2. Data Actions Merger</h2>

<pre>
apps/common/php/actions.php
</pre>

<p>
This file contains functionality for merging action controls
with data rows in tables or lists, including permission checks
</p>

<section id="toc26">
<h3>2.2.1. Merge data with actions</h3>

<pre>
function __merge_data_actions($data, $actions)
</pre>

<p>
Combines dataset rows with action controls while verifying permissions.
Processes each action definition, checks user permissions, and attaches
permitted actions to each data row.
</p>

<ul>
<li>@data    =&gt; Dataset containing rows to display in table/list
</li>
<li>@actions =&gt; Action definitions to merge with each data row
</li>
</ul>

<p>
Returns the modified dataset with actions attached to each row
</p>
<p>
Throws error if actions parameter is not an array
</p>

</section>
</section>
<section id="toc27">
<h2>2.3. Apps helper module</h2>

<pre>
apps/common/php/default.php
</pre>

<p>
This file contains functions intended to be used as hepers of other functions,
allowing to convert between formats like yaml to xml using a small specification
</p>

<section id="toc28">
<h3>2.3.1. Make app file</h3>

<pre>
function make_app_file($data)
</pre>

<p>
This function returns the xml of an app using the follow specs passed in @data:
</p>

<ul>
<li>@require   =&gt; this field defines the required php that contains the make_app_file
              function like this file
</li>
<li>@_template =&gt; the xml app file used as template, this file contains the default
              specification of the app used in the quick apps defined in the yaml
</li>
<li>@screen    =&gt; the screen used by the template
</li>
<li>@list      =&gt; the list of fields used in the list screen, this must be a list of
              arrays with 3 elements: id, type and label, types can be as follow:
              -text    =&gt; default field with text
              -select  =&gt; this field resolves the text from a table and field, see
                          the @select spec
              -boolean =&gt; this field uses an icon with V o X in green or red to
                          see the value of the field (generaly 1 or 0)
              -hastext =&gt; this field is similar to boolean but the true or false
                          is detedmined using the contents of the text, no text is
                          false and some text is true
</li>
<li>@form      =&gt; the list of fields used in the form screen, this must be a list of
              arrays with 3 elements: id, type and label, types can be as follow:
              <ul>
              <li>text, date, time, datetime, checkbox, switch =&gt; default widget
              </li>
              <li>textarea, ckeditor, codemirror =&gt; widget with 10em of height
              </li>
              <li>select =&gt; widget that uses the select spec to resolve the contents
              </li>
              </ul>
</li>
<li>@select    =&gt; this spec is intended to defined the selects used in the list and
              forms, requires an array of 3 elements: id, table and field, if the
              last field is not specified, saltos tries to resolve it using the
              manifest information (internally use the table2field feature)
</li>
<li>@attr      =&gt; this part contain an array with extra features added to the forms
              widgets, the spec requires to use a named array that defines the
              id of the field and each array entry must to be another pair of
              key and val with the name of the property and the value of it
</li>
</ul>

</section>
</section>
<section id="toc29">
<h2>2.4. File management functions</h2>

<pre>
apps/common/php/files.php
</pre>

<p>
These functions handle file operations such as listing files, retrieving file paths,
checking for file existence, and viewing file contents. They are primarily designed
to interact with the `data/logs` directory.
</p>

<section id="toc30">
<h3>2.4.1. List files in the logs directory</h3>

<pre>
function __files_list($search, $offset, $limit)
</pre>

<p>
This function retrieves a list of files from the `data/logs` directory, applies search filters,
and paginates the results based on the specified offset and limit. The returned data includes
metadata such as file size and type.
</p>

<ul>
<li>@search =&gt; Search term or query to filter files.
</li>
<li>@offset =&gt; Offset for pagination.
</li>
<li>@limit  =&gt; Maximum number of files to retrieve.
</li>
</ul>

<p>
Returns a list of files with metadata including ID, name, size, and type.
</p>

</section>
<section id="toc31">
<h3>2.4.2. Get the full path of a file</h3>

<pre>
function __files_getfile($file)
</pre>

<p>
This function searches for a file by its name in the `data/logs` directory and returns
its full path if found. Otherwise, it returns an empty string.
</p>

<ul>
<li>@file =&gt; Name of the file to search for.
</li>
</ul>

<p>
Returns the full path of the file or an empty string if not found.
</p>

</section>
<section id="toc32">
<h3>2.4.3. Check if a file exists</h3>

<pre>
function __files_check($file)
</pre>

<p>
This function checks whether a file exists in the `data/logs` directory by searching for its name.
</p>

<ul>
<li>@file =&gt; Name of the file to check.
</li>
</ul>

<p>
Returns `true` if the file exists, otherwise `false`.
</p>

</section>
<section id="toc33">
<h3>2.4.4. View the contents of a file</h3>

<pre>
function __files_view($file)
</pre>

<p>
This function retrieves the contents of a file from the `data/logs` directory. It supports both
regular files and gzip-compressed files. The returned data includes the file name, size, type, and content.
</p>

<ul>
<li>@file =&gt; Name of the file to view.
</li>
</ul>

<p>
Returns metadata and content of the file. If the file is not found, it returns an error response.
</p>

</section>
</section>
<section id="toc34">
<h2>2.5. Matrix functions</h2>

<pre>
apps/common/php/matrix.php
</pre>

<p>
This file contains all the functions required by the Excel widget for handling
version and log data in a matrix format.
</p>

<section id="toc35">
<h3>2.5.1. Create matrix for version data</h3>

<pre>
function make_matrix_version($app, $id)
</pre>

<p>
This function generates a matrix structure for displaying version-related data
in the Excel widget, including headers, data formatting, and cell attributes.
</p>

</section>
<section id="toc36">
<h3>2.5.2. Create matrix for log data</h3>

<pre>
function make_matrix_log($app, $id)
</pre>

<p>
This function processes log data and generates headers and formatting information
for integration into the Excel widget.
</p>

</section>
</section>
</section>
<section id="toc37">
<h1>3. Crm</h1>

<section id="toc38">
<h2>3.1. Quotes application</h2>

<pre>
apps/crm/js/quotes.js
</pre>

<p>
This application provides core functionalities for managing quotes, including creating,
editing, viewing, and exporting quotes in PDF format.
</p>

<section id="toc39">
<h3>3.1.1. Main object</h3>

<pre>
saltos.quotes = {};
</pre>

<p>
This object contains all SaltOS code related to quote operations.
</p>

</section>
<section id="toc40">
<h3>3.1.2. Initialize the quotes application</h3>

<pre>
saltos.quotes.init = arg
</pre>

<p>
This method handles initialization tasks based on the type of operation (`view`, `create`, or `edit`).
It updates UI elements and attaches appropriate event listeners.
</p>

<ul>
<li>@arg =&gt; Specifies the type of operation to initialize.
</li>
</ul>

</section>
<section id="toc41">
<h3>3.1.3. Calculate the dynamic width for each column in the "lines" table.</h3>

<pre>
saltos.quotes.colWidths_lines = index
</pre>

<p>
This function returns the width for each column. For the first column (index 0),
it dynamically calculates the remaining space based on the container width minus
a fixed width (500px) reserved for other columns. For all other columns, it returns 100px.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc42">
<h3>3.1.4. Define cell configuration for each column in the "lines" table.</h3>

<pre>
saltos.quotes.cells_lines = (row, column, prop)
</pre>

<p>
This function provides per-column behavior:
</p>

<ul>
<li>Column 4: renders a dropdown with available tax values (from #alltaxes).
</li>
<li>Column 5: sets the cell as read-only (used for calculated values).
</li>
<li>Other columns: no special config.
</li>
</ul>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc43">
<h3>3.1.5. Calculate the dynamic width for each column in the "taxes" table.</h3>

<pre>
saltos.quotes.colWidths_taxes = index
</pre>

<p>
The first column (index 0) fills the available space minus 200px reserved for other columns.
All other columns get a fixed width of 100px.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc44">
<h3>3.1.6. Define cell configuration for each column in the "taxes" table.</h3>

<pre>
saltos.quotes.cells_taxes = (row, column, prop)
</pre>

<p>
All cells in this table are read-only.
</p>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc45">
<h3>3.1.7. Calculate equal column widths for the "totals" table.</h3>

<pre>
saltos.quotes.colWidths_totals = index
</pre>

<p>
The table is divided into 3 equal columns, based on the container width.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc46">
<h3>3.1.8. Define cell configuration for the "totals" table.</h3>

<pre>
saltos.quotes.cells_totals = (row, column, prop)
</pre>

<p>
All cells in this table are read-only.
</p>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc47">
<h3>3.1.9. Handle and recalculate quote line totals and tax breakdowns after user edits.</h3>

<pre>
saltos.quotes.afterChange_lines = (changes, source)
</pre>

<p>
This function is triggered after the user modifies any cell in the "lines" matrix
(quote lines). It performs the following operations:
</p>

<ul>
<li>Ignores changes triggered by internal actions (non-`edit` sources).
</li>
<li>Validates and normalizes quantity, price, and discount values:
    <ul>
    <li>Ensures `line[1]`, `line[2]`, `line[3]` (qty, price, discount) are numeric.
    </li>
    <li>Defaults discount to 0 if empty but qty and price are valid.
    </li>
    </ul>
</li>
<li>Calculates the line total as: `qty × price × (1 - discount%)`, rounded to 2 decimals.
</li>
<li>Updates the lines grid to reflect computed values.
</li>
<li>Recomputes the taxes matrix:
    <ul>
    <li>Aggregates taxable bases per tax value (`line[4]`).
    </li>
    <li>Computes tax amount for each group: `base × (tax% / 100)`.
    </li>
    </ul>
</li>
<li>Rounds all tax results to 2 decimals and updates the taxes grid.
</li>
<li>Computes the totals matrix:
    <ul>
    <li>`subtotal` = sum of all taxable bases
    </li>
    <li>`tax` = sum of all tax amounts
    </li>
    <li>`total` = subtotal + tax
    </li>
    <li>Results are rounded and shown in the totals grid.
    </li>
    </ul>
</li>
</ul>

<ul>
<li>@changes =&gt; Array of cell changes from the spreadsheet component
</li>
<li>@source  =&gt; Source of the change event (only `'edit'` triggers processing)
</li>
</ul>

</section>
</section>
<section id="toc48">
<h2>3.2. Reverses the process of `make_matrix_data()` for the `quotes` app.</h2>

<pre>
apps/crm/php/quotes.php
</pre>

<p>
This function takes a previously generated matrix-style array of quote data
(grouped as lines, taxes, and totals), compares it with the current values
in the database, and builds a minimal diff-like array that includes only
the fields that have changed, been removed, or added.
</p>

<section id="toc49">
<h3>3.2.1. unmake_matrix_data</h3>

<pre>
function unmake_matrix_data($json, $quote_id)
</pre>

<p>
Reverse the matrix-encoded quote data to a diff-style data array.
</p>

<ul>
<li>@json     =&gt; The matrix-encoded quote data (from make_matrix_data)
</li>
<li>@quote_id =&gt; The quote ID used to retrieve the original data
</li>
</ul>

<p>
Return a diff array representing only the differences between the provided
data and the current state of the database.
</p>

</section>
<section id="toc50">
<h3>3.2.2. Generates or completes quote and final quote metadata.</h3>

<pre>
function set_quote($json, $quote_id)
</pre>

<p>
This function ensures that the given quote JSON structure has appropriate values for:
</p>

<ul>
<li>`code`, `date` and `valid_until` (if not provided or if it's a new quote)
</li>
</ul>

<p>
Rules:
</p>

<ul>
<li>If no `quote_id` is given or `code` is not defined, a new code number is generated.
</li>
</ul>

<ul>
<li>@json     =&gt; Quote data to process and complete.
</li>
<li>@quote_id =&gt; ID of the quote, used to retrieve current status from DB.
</li>
</ul>

<p>
Return the updated JSON with appropriate codes and dates filled in.
</p>

</section>
</section>
</section>
<section id="toc51">
<h1>4. Dashboard</h1>

<section id="toc52">
<h2>4.1. Dashboard application</h2>

<pre>
apps/dashboard/js/dashboard.js
</pre>

<p>
This module implements the typical features associated with a dashboard,
allowing dynamic interaction with various elements and functionalities.
</p>

<section id="toc53">
<h3>4.1.1. Main object</h3>

<pre>
saltos.dashboard = {};
</pre>

<p>
Contains all the logic and code for the SaltOS framework related to the dashboard.
</p>

</section>
<section id="toc54">
<h3>4.1.2. Initialization of dashboard</h3>

<pre>
saltos.dashboard.init = arg
</pre>

<p>
This method sets up listeners, configures the catalog layout, and initializes
the dashboard widgets based on user-defined or default configurations.
</p>

</section>
</section>
<section id="toc55">
<h2>4.2. Dashboard widgets application</h2>

<pre>
apps/dashboard/js/dashboard_widgets.js
</pre>

<p>
This module implements the typical features associated with a widget dashboard,
allowing interaction and customization of elements in a dynamic environment.
</p>

<section id="toc56">
<h3>4.2.1. Main object</h3>

<pre>
saltos.dashboard_widgets = {};
</pre>

<p>
Contains all the logic and code for the SaltOS framework related to the dashboard widgets.
</p>

</section>
<section id="toc57">
<h3>4.2.2. Initialization of dashboard widgets</h3>

<pre>
saltos.dashboard_widgets.init = arg
</pre>

<p>
This method sets up the interactive elements of the dashboard, including assigning style classes
and configuring drag-and-drop functionality between different containers.
</p>

</section>
</section>
<section id="toc58">
<h2>4.3. Dashboard and navbar generation logic.</h2>

<pre>
apps/dashboard/php/dashboard.php
</pre>

<p>
This file contains helper functions used to build the SaltOS dashboard and navbar
dynamically based on the applications configured in the system and the permissions
of the current user.
</p>
<p>
Functions included:
</p>

<ul>
<li>__dashboard_helper(): Generates the full dashboard widget layout (alerts, buttons, separators)
</li>
<li>__dashboard_config(): Applies user-specific configuration to customize the dashboard layout
</li>
<li>__navbar_helper(): Builds the application menu structure for the top navigation bar
</li>
</ul>

<p>
These functions are used internally by the SaltOS UI rendering engine to generate
the initial layout and navigation menus seen by each user on login.
</p>

<section id="toc59">
<h3>4.3.1. Build the default dashboard layout with groups and application buttons.</h3>

<pre>
function __dashboard_helper()
</pre>

<p>
This function retrieves all active applications from `tbl_apps`,
groups them by `group`, filters them by user permissions (menu access),
and then formats them into a widget-based structure suitable for rendering
on the dashboard, including alerts, buttons, and separators.
</p>
<p>
Each group of apps is preceded by an alert (group title and description),
followed by buttons for each app, and a horizontal rule (`&lt;hr&gt;`) at the end.
</p>

<ul>
<li>@return array An array of widgets (alerts, buttons, hr) to render the dashboard
</li>
</ul>

</section>
<section id="toc60">
<h3>4.3.2. Build a personalized dashboard layout based on user config.</h3>

<pre>
function __dashboard_config()
</pre>

<p>
This function loads the full list of dashboard items using `__dashboard_helper()`
and then tries to fetch the widget configuration saved by the current user
under the path `app/dashboard/widgets/default`.
</p>
<p>
If configuration is found, it reconstructs the dashboard by preserving only
the items selected by the user, in the specified order. Otherwise, it returns
the default layout.
</p>

<ul>
<li>@return array The personalized or default dashboard widget list
</li>
</ul>

</section>
<section id="toc61">
<h3>4.3.3. Build the application menu for the navbar.</h3>

<pre>
function __navbar_helper()
</pre>

<p>
This function generates the main application menu for the navbar by:
</p>

<ul>
<li>Fetching all active apps grouped by `group`
</li>
<li>Filtering them by user permissions
</li>
<li>Mapping the group metadata from `tbl_apps_groups`
</li>
<li>Creating a linear structure of `&lt;item&gt;` elements including:
  <ul>
  <li>Group labels (disabled items)
  </li>
  <li>App entries with onclick handlers
  </li>
  <li>A divider after each group
  </li>
  </ul>
</li>
</ul>

<p>
The result is an array of menu items that represents the full application
navigation tree grouped visually in the UI.
</p>

<ul>
<li>@return array An array of navbar `&lt;item&gt;` definitions
</li>
</ul>

</section>
</section>
</section>
<section id="toc62">
<h1>5. Emails</h1>

<section id="toc63">
<h2>5.1. Email application</h2>

<pre>
apps/emails/js/driver.js
</pre>

<p>
This application implements the typical features associated with email functionality,
including templates and initialization processes for handling email-related tasks.
</p>

<section id="toc64">
<h3>5.1.1. Driver emails object</h3>

<pre>
saltos.driver.__types.emails = {};
</pre>

<p>
This object stores the functions and properties used by the email driver,
providing the necessary methods for managing email operations.
</p>

</section>
<section id="toc65">
<h3>5.1.2. Create email template</h3>

<pre>
saltos.driver.__types.emails.template = arg
</pre>

<p>
This function generates a template for the email driver, configuring specific
attributes and layout modifications. It sets the 'type' attribute to 'emails'
and adjusts the layout of the corresponding element for proper display.
</p>

</section>
<section id="toc66">
<h3>5.1.3. Initialization, open, and close handlers for emails</h3>

<pre>
saltos.driver.__types.emails.init = saltos.driver.__types.type5.init; // Inherits initialization from type5
</pre>

<p>
These methods inherit their implementations from the 'type5' driver, allowing
reuse of core functionality for initializing, opening, and closing email resources.
</p>

</section>
</section>
<section id="toc67">
<h2>5.2. Email application</h2>

<pre>
apps/emails/js/emails.js
</pre>

<p>
This application implements typical features associated with email functionality,
such as initialization, server actions, email deletion, sending, setting states,
handling signatures, generating and downloading PDFs, viewing email sources, replying
and forwarding.
</p>

<section id="toc68">
<h3>5.2.1. Main object</h3>

<pre>
saltos.emails = {};
</pre>

<p>
This object contains all SaltOS code related to email operations.
</p>

</section>
<section id="toc69">
<h3>5.2.2. Initialize the email application</h3>

<pre>
saltos.emails.init = arg
</pre>

<p>
This method handles initialization tasks for different views (`create`, `view`, `close`, `list`)
in the email application. It manages UI updates, visibility behaviors, and email state changes.
</p>

<ul>
<li>@param {string} arg Specifies the type of view or action to initialize.
</li>
</ul>

</section>
<section id="toc70">
<h3>5.2.3. Perform server-related actions for emails</h3>

<pre>
saltos.emails.server = ()
</pre>

<p>
This method triggers server-side actions for emails and displays the responses in toasts.
</p>

</section>
<section id="toc71">
<h3>5.2.4. Delete selected emails</h3>

<pre>
saltos.emails.delete1 = ()
</pre>

<p>
This method deletes multiple emails selected by the user, after showing a confirmation modal.
</p>

</section>
<section id="toc72">
<h3>5.2.5. Delete a single email</h3>

<pre>
saltos.emails.delete2 = ()
</pre>

<p>
This method deletes the currently viewed email after showing a confirmation modal.
</p>

</section>
<section id="toc73">
<h3>5.2.6. Send an email</h3>

<pre>
saltos.emails.send = ()
</pre>

<p>
This method validates the required fields and sends the email data to the server.
It handles responses and clears unsaved data on success.
</p>

</section>
<section id="toc74">
<h3>5.2.7. Set email state</h3>

<pre>
saltos.emails.setter = what
</pre>

<p>
This function updates the state of a specific email identified by its ID. The updated state is sent
to the server, and the UI is refreshed afterward.
</p>

<ul>
<li>@param {string} what Specifies the state to set for the email.
</li>
</ul>

</section>
<section id="toc75">
<h3>5.2.8. Add signature to email</h3>

<pre>
saltos.emails.signature = ()
</pre>

<p>
This function applies the email signature based on the selected account and its related data.
The signature is retrieved from the server and updated in the email form.
</p>

</section>
<section id="toc76">
<h3>5.2.9. View email source</h3>

<pre>
saltos.emails.source = ()
</pre>

<p>
This function opens the raw source of the selected email for viewing in the driver.
</p>

</section>
<section id="toc77">
<h3>5.2.10. Reply to an email</h3>

<pre>
saltos.emails.reply = ()
</pre>

<p>
This function opens the reply form for the currently selected email.
</p>

</section>
<section id="toc78">
<h3>5.2.11. Reply to all recipients of an email</h3>

<pre>
saltos.emails.replyall = ()
</pre>

<p>
This function opens the reply-all form for the currently selected email, including all recipients.
</p>

</section>
<section id="toc79">
<h3>5.2.12. Forward an email</h3>

<pre>
saltos.emails.forward = ()
</pre>

<p>
This function opens the forward form for the currently selected email.
</p>

</section>
</section>
<section id="toc80">
<h2>5.3. Email Query Builder</h2>

<pre>
apps/emails/php/filter.php
</pre>

<p>
This function builds an SQL WHERE query for filtering emails based on various criteria
such as account, fields, search terms, dates, and specific email states.
</p>

<section id="toc81">
<h3>5.3.1. Generate WHERE query for emails</h3>

<pre>
function make_where_query_emails($json)
</pre>

<p>
This function takes a JSON input and generates a dynamic SQL WHERE clause to filter emails.
The query is constructed based on several optional parameters such as account ID, search fields,
dates, and flags indicating specific states (e.g., new emails, waiting emails, spam).
</p>

<ul>
<li>@json =&gt; Input parameters for generating the query.
</li>
</ul>

<p>
Returns the dynamically constructed SQL WHERE clause.
</p>

</section>
</section>
<section id="toc82">
<h2>5.4. Get email library</h2>

<pre>
apps/emails/php/getmail.php
</pre>

<p>
This library provides the necesary functions to download, parse and manage emails.
</p>

<section id="toc83">
<h3>5.4.1. Requires section</h3>

<pre>
require_once 'apps/emails/lib/mimeparser/mime_parser.php';
</pre>

<p>
This requires loads the external libraries needed to run this library.
</p>

</section>
<section id="toc84">
<h3>5.4.2. Defines section</h3>

<pre>
// phpcs:disable Generic.Files.LineLength
</pre>

<p>
This defines allow to define some useful standards to do html pages and more.
</p>

</section>
<section id="toc85">
<h3>5.4.3. Remove all body</h3>

<pre>
function __getmail_removebody($array)
</pre>

<p>
This function removes the body entry in the array, it is only for debug purposes
</p>

<ul>
<li>@aarray =&gt; The array that you want to process
</li>
</ul>

</section>
<section id="toc86">
<h3>5.4.4. Process message</h3>

<pre>
function __getmail_processmessage($disp, $type)
</pre>

<p>
This function returns a boolean that identify if the disposition and the type
allow the node to be processed.
</p>

<ul>
<li>@disp =&gt; disposition, can be inline or attachment
</li>
<li>@type =&gt; type, can be message, html or plain
</li>
</ul>

</section>
<section id="toc87">
<h3>5.4.5. Process plain html</h3>

<pre>
function __getmail_processplainhtml($disp, $type)
</pre>

<p>
This function returns a boolean that identify if the disposition and the type
allow the node to be processed.
</p>

<ul>
<li>@disp =&gt; disposition, can be inline or attachment
</li>
<li>@type =&gt; type, can be message, html or plain
</li>
</ul>

</section>
<section id="toc88">
<h3>5.4.6. Process file</h3>

<pre>
function __getmail_processfile($disp, $type)
</pre>

<p>
This function returns a boolean that identify if the disposition and the type
allow the node to be processed.
</p>

<ul>
<li>@disp =&gt; disposition, can be inline or attachment
</li>
<li>@type =&gt; type, can be message, html or plain
</li>
</ul>

</section>
<section id="toc89">
<h3>5.4.7. Check permissions</h3>

<pre>
function __getmail_checkperm($id)
</pre>

<p>
This function allow to check if the current user has permissions to view the
message identified by the id argument
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc90">
<h3>5.4.8. Get GZ File</h3>

<pre>
function __getmail_gzfile($id)
</pre>

<p>
This function returns the file that contains the email
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc91">
<h3>5.4.9. Get source</h3>

<pre>
function __getmail_getsource($id)
</pre>

<p>
This function returns the original RFC822 message as string
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

<p>
Notes:
</p>
<p>
This function returns the email source without the base64 attachments
</p>

</section>
<section id="toc92">
<h3>5.4.10. Mime decode protected</h3>

<pre>
function __getmail_mime_decode_protected($input)
</pre>

<p>
This function decodes the input string that contains the RFC822 message
using the mime_parser_class to do it, and returns the decoded array.
</p>

<ul>
<li>@input =&gt; the RFC822 string that contains the message
</li>
</ul>

</section>
<section id="toc93">
<h3>5.4.11. Get mime</h3>

<pre>
function __getmail_getmime($id)
</pre>

<p>
This function returns the decoded array of the email identified by the id
argument, to do this more optimal, this function uses an internal cache
file to improve the performance for repeated executions.
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc94">
<h3>5.4.12. Get Node</h3>

<pre>
function __getmail_getnode($path, $array)
</pre>

<p>
This function returns the node using a xpath notation
</p>

<ul>
<li>@path  =&gt; xpath that identify the desired path that must to be returned
</li>
<li>@array =&gt; the decoded message in an array format
</li>
</ul>

</section>
<section id="toc95">
<h3>5.4.13. Get type</h3>

<pre>
function __getmail_gettype($array)
</pre>

<p>
This function tries to unify the differents content-type to standarize it into
the follow formats: html, plain, messsage, alternative, multipart or other.
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
</ul>

</section>
<section id="toc96">
<h3>5.4.14. Get disposition</h3>

<pre>
function __getmail_getdisposition($array)
</pre>

<p>
This function tries to unify the differents content-dispoaition to standarize
it into the follow formats: attachment, inline or other.
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
</ul>

</section>
<section id="toc97">
<h3>5.4.15. Get files</h3>

<pre>
function __getmail_getfiles($array, $level = 0)
</pre>

<p>
This function returns an array with the attachment files of the message
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
<li>@level =&gt; this parameter is internally used to detect recursion
</li>
</ul>

</section>
<section id="toc98">
<h3>5.4.16. Get info</h3>

<pre>
function __getmail_getinfo($array)
</pre>

<p>
Returns all information of the decoded message in a structured format
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
</ul>

</section>
<section id="toc99">
<h3>5.4.17. Fix string</h3>

<pre>
function __getmail_fixstring($arg)
</pre>

<p>
This function is a helper used by all functions that pcoesses the headers
of the decoded message.
</p>

<ul>
<li>@arg =&gt; the string that must to be checked and fixed if needed
</li>
</ul>

</section>
<section id="toc100">
<h3>5.4.18. Get text body</h3>

<pre>
function __getmail_gettextbody($array, $level = 0)
</pre>

<p>
This function returns all text body concatenated as an unique string
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
<li>@level =&gt; this parameter is internally used to detect recursion
</li>
</ul>

</section>
<section id="toc101">
<h3>5.4.19. Get full body</h3>

<pre>
function __getmail_getfullbody($array)
</pre>

<p>
This function returns all body and attachments information as an array
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
</ul>

</section>
<section id="toc102">
<h3>5.4.20. Get cid</h3>

<pre>
function __getmail_getcid($array, $hash)
</pre>

<p>
This function returns the requested attachment indentified by the hash argument
</p>

<ul>
<li>@array =&gt; the decoded message in an array format
</li>
<li>@hash  =&gt; the hash of the content requested
</li>
</ul>

</section>
<section id="toc103">
<h3>5.4.21. Insert</h3>

<pre>
function __getmail_insert(
</pre>

<p>
This function do the insert in the app_emails table, and
</p>

<ul>
<li>@file          =&gt; the gzfile that contains the message in RFC822 format
</li>
<li>@messageid     =&gt; the id of the message (account_id/uidl)
</li>
<li>@state_new     =&gt; the 0/1 that sets the state new flag
</li>
<li>@state_reply   =&gt; the 0/1 that sets the state reply flag
</li>
<li>@state_forward =&gt; the 0/1 that sets the state forward flag
</li>
<li>@state_wait    =&gt; the 0/1 that sets the state wait flag
</li>
<li>@id_correo     =&gt; the id of the related email (used to create relations between emails)
</li>
<li>@is_outbox     =&gt; the 0/1 that sets the is outbox flag
</li>
<li>@state_sent    =&gt; the 0/1 that sets the state sent flag
</li>
<li>@state_error   =&gt; the string that contains the error (if exists an error)
</li>
</ul>

</section>
<section id="toc104">
<h3>5.4.22. Update</h3>

<pre>
function __getmail_update($field, $value, $id)
</pre>

<p>
This function updates the field with the value of the app_emails for the
register identified by the id argument.
</p>

<ul>
<li>@field =&gt; field that you want to update
</li>
<li>@value =&gt; value that you want to set
</li>
<li>@id    =&gt; id of the register to do the update
</li>
</ul>

</section>
<section id="toc105">
<h3>5.4.23. Add bcc</h3>

<pre>
function __getmail_add_bcc($id, $bcc)
</pre>

<p>
This function adds the bbc to the database, this is because the messages
does not contains the bcc field (is hidden in theory), and only is available
if the current execution is the sender of the message.
</p>

<ul>
<li>@id  =&gt; id of the email
</li>
<li>@bcc =&gt; an array with the addresses of the emails
</li>
</ul>

</section>
<section id="toc106">
<h3>5.4.24. Gzfile size</h3>

<pre>
function gzfilesize($filename)
</pre>

<p>
This function is copied from <a href="http://php.net/manual/es/function.gzread.php#110078">http://php.net/manual/es/function.gzread.php#110078</a>
and allow to know the file size of the file after a gzip descompression.
</p>

<ul>
<li>@filename =&gt; the gzip filename that you want to know the size
</li>
</ul>

</section>
<section id="toc107">
<h3>5.4.25. Get email body</h3>

<pre>
function getmail_body($id, $images = false)
</pre>

<p>
This function returns the string that contains the body of the email
intended to be rendered in an iframe, for example
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc108">
<h3>5.4.26. Generate formatted email header information</h3>

<pre>
function __getmail_head_helper($decoded, $email_id)
</pre>

<p>
This function extracts and formats header details from the decoded email structure,
including sender, recipients, date, subject, and attachments. It handles edge cases
such as missing data, and ensures that all information is presented in a structured
and readable format. HTML encoding is applied to ensure safe display within a web interface.
</p>

<ul>
<li>@decoded  =&gt; Decoded structure of the email, containing metadata and header information.
</li>
<li>@email_id =&gt; ID of the email to retrieve additional account-specific details.
</li>
</ul>

<p>
Returns a formatted HTML string with the email header information.
</p>

</section>
<section id="toc109">
<h3>5.4.27. Extract and format the body of an email</h3>

<pre>
function __getmail_body_helper($decoded, $images = false)
</pre>

<p>
This function processes the decoded content of an email, extracting the plain
text and HTML bodies while applying necessary transformations for safe and
structured display. It handles inline images, styles, and embedded attachments,
ensuring compatibility and security.
</p>

<ul>
<li>@decoded =&gt; Decoded structure of the email, typically containing nodes with
            metadata and body content.
</li>
<li>@images  =&gt; Specifies whether inline images should be embedded directly into
            the content.
</li>
</ul>

<p>
Returns the formatted email body, including plain text, HTML, and inline attachments.
</p>

</section>
<section id="toc110">
<h3>5.4.28. Get email source</h3>

<pre>
function getmail_source($id)
</pre>

<p>
This function returns the string that contains the source of the email
intended to be rendered in an iframe, for example
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc111">
<h3>5.4.29. Get email files</h3>

<pre>
function getmail_files($id)
</pre>

<p>
This function returns an arryy that contains the files of the email
intended to be rendered in an table, for example
</p>

<ul>
<li>@id =&gt; id of the email
</li>
</ul>

</section>
<section id="toc112">
<h3>5.4.30. Get cid</h3>

<pre>
function getmail_cid($id, $cid)
</pre>

<p>
This function returns the requested attachment indentified by the cid argument
</p>

<ul>
<li>@id  =&gt; id of the email
</li>
<li>@cid =&gt; the cid of the content requested
</li>
</ul>

</section>
<section id="toc113">
<h3>5.4.31. Is outbox</h3>

<pre>
function getmail_field($field, $id)
</pre>

<p>
Returns the field of the email identified by the id argument
</p>

<ul>
<li>@field =&gt; field requested
</li>
<li>@id    =&gt; id of the email
</li>
</ul>

</section>
<section id="toc114">
<h3>5.4.32. Server</h3>

<pre>
function getmail_server()
</pre>

<p>
This function implements the old getmail action of the old saltos.
</p>

</section>
<section id="toc115">
<h3>5.4.33. Delete</h3>

<pre>
function getmail_delete($ids)
</pre>

<p>
This function implements the old delete action of the old saltos.
</p>

<ul>
<li>@ids =&gt; array with the emails id
</li>
</ul>

</section>
<section id="toc116">
<h3>5.4.34. Get viewpdf</h3>

<pre>
function getmail_viewpdf($id, $cid)
</pre>

<p>
This function returns the requested attachment indentified by the cid argument
in a pdf format for the viewpdf widget
</p>

<ul>
<li>@id  =&gt; id of the email
</li>
<li>@cid =&gt; the cid of the content requested
</li>
</ul>

</section>
<section id="toc117">
<h3>5.4.35. Get download</h3>

<pre>
function getmail_download($id, $cid)
</pre>

<p>
This function returns the requested attachment indentified by the cid argument
in an array format for the download feature
</p>

<ul>
<li>@id  =&gt; id of the email
</li>
<li>@cid =&gt; the cid of the content requested
</li>
</ul>

</section>
<section id="toc118">
<h3>5.4.36. Update email states</h3>

<pre>
function getmail_setter($ids, $what)
</pre>

<p>
This function modifies the state of emails (e.g., `new`, `wait`, or `spam`)
based on the provided IDs and action. It validates user permissions for the
selected emails before updating their states. The function calculates the
number of records to be modified and updates the database accordingly.
</p>

<ul>
<li>@ids  =&gt; Comma-separated list of email IDs to be updated.
</li>
<li>@what =&gt; Specifies the state change in the format `key=value` (e.g., `new=0`).
</li>
</ul>

<p>
Returns a response message indicating the number of emails modified.
</p>

</section>
<section id="toc119">
<h3>5.4.37. Generate PDF from emails</h3>

<pre>
function getmail_pdf($ids)
</pre>

<p>
This function generates PDF files for the provided email IDs using either the
`wkhtmltopdf` command or a fallback library. If multiple emails are selected,
their PDFs are merged into a single file. It validates user permissions for
accessing the emails and manages caching for performance optimization.
</p>

<ul>
<li>@ids =&gt; List or comma-separated string of email IDs to generate PDFs for.
</li>
</ul>

<p>
Returns metadata of the generated PDF file, including its name, type, and
base64-encoded data.
</p>

</section>
<section id="toc120">
<h3>5.4.38. Generate iframe content with secure policies</h3>

<pre>
function __iframe_srcdoc_helper($html)
</pre>

<p>
This function generates the `srcdoc` content for an iframe element, embedding
the provided HTML string. It ensures the content is styled using predefined
fonts and enforces a strict Content Security Policy (CSP) to limit the sources
for styles, fonts, and images. This helps maintain security and compatibility
within the iframe.
</p>

<ul>
<li>@html =&gt; The HTML content to be embedded in the iframe.
</li>
</ul>

<p>
Return a complete HTML document string suitable for `srcdoc` use in an iframe.
</p>

</section>
</section>
<section id="toc121">
<h2>5.5. Html helper module</h2>

<pre>
apps/emails/php/html.php
</pre>

<p>
This file contain useful html helper functions
</p>

<section id="toc122">
<h3>5.5.1. Defines section</h3>

<pre>
define('__GIF_IMAGE__', 'data:image/gif;base64,R0lGODlhCgABAIABAOns7////ywAAAAACgABAAACA4SPBQA7');
</pre>

<p>
This defines allow to define some useful needed resources by this file.
</p>

</section>
<section id="toc123">
<h3>5.5.2. Remove Script Tag</h3>

<pre>
function remove_script_tag($html)
</pre>

<p>
This function tries to remove all &lt;script&gt; tags of the string
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc124">
<h3>5.5.3. Remove Style Tag</h3>

<pre>
function remove_style_tag($html)
</pre>

<p>
This function tries to remove all &lt;style&gt; tags of the string
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc125">
<h3>5.5.4. Remove Comment Tag</h3>

<pre>
function remove_comment_tag($html)
</pre>

<p>
This function tries to remove all &lt;!-- --&gt; tags of the string
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc126">
<h3>5.5.5. Remove Meta Tag</h3>

<pre>
function remove_meta_tag($html)
</pre>

<p>
This function tries to remove all &lt;meta &gt; tags of the string
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc127">
<h3>5.5.6. Remove Link Tag</h3>

<pre>
function remove_link_tag($html)
</pre>

<p>
This function tries to remove all &lt;link &gt; tags of the string
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc128">
<h3>5.5.7. Inline Img Tag</h3>

<pre>
function inline_img_tag($html)
</pre>

<p>
This function tries to convert all imgs to an inline imgs
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc129">
<h3>5.5.8. Inline Img Style</h3>

<pre>
function inline_img_style($html)
</pre>

<p>
This function tries to convert all imgs to an inline imgs
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc130">
<h3>5.5.9. Inline Img Background</h3>

<pre>
function inline_img_background($html)
</pre>

<p>
This function tries to convert all imgs to an inline imgs
</p>

<ul>
<li>@temp =&gt; the string that you want to process
</li>
</ul>

</section>
<section id="toc131">
<h3>5.5.10. Inline Image Helper</h3>

<pre>
function __inline_img_helper($src)
</pre>

<p>
This function fetches and processes image URLs, ensuring compatibility and resizing
where necessary. It also manages caching and handles errors gracefully.
</p>

<ul>
<li>@src =&gt; Image source URL or path.
</li>
</ul>

<p>
Returns the inline image data or a placeholder GIF in case of errors.
</p>

</section>
<section id="toc132">
<h3>5.5.11. Extract Inline Images from Tags</h3>

<pre>
function extract_img_tag($html)
</pre>

<p>
This function extracts inline images from HTML `&lt;img&gt;` tags and replaces their `src`
attributes with `cid` references for email compatibility.
</p>

<ul>
<li>@html =&gt; HTML content to parse.
</li>
</ul>

<p>
Returns the modified HTML content and an array of image files.
</p>

</section>
<section id="toc133">
<h3>5.5.12. Extract Inline Images from Styles</h3>

<pre>
function extract_img_style($html)
</pre>

<p>
This function extracts images embedded in CSS `style` attributes and replaces them
with `cid` references for email compatibility.
</p>

<ul>
<li>@html =&gt; HTML content to parse.
</li>
</ul>

<p>
Returns the modified HTML content and an array of image files.
</p>

</section>
<section id="toc134">
<h3>5.5.13. Extract Inline Images from Backgrounds</h3>

<pre>
function extract_img_background($html)
</pre>

<p>
This function extracts images embedded in HTML `background` attributes and replaces them
with `cid` references for email compatibility.
</p>

<ul>
<li>@html =&gt; HTML content to parse.
</li>
</ul>

<p>
Returns the modified HTML content and an array of image files.
</p>

</section>
<section id="toc135">
<h3>5.5.14. Fix Image Tags</h3>

<pre>
function fix_img_tag($html)
</pre>

<p>
This function processes `&lt;img&gt;` tags in the given HTML to replace non-inline image `src` attributes
with a placeholder image (`<span class="underline">GIF_IMAGE</span>`), ensuring compatibility and avoiding external dependencies.
</p>

<ul>
<li>@html =&gt; The HTML content to process.
</li>
</ul>

<p>
Returns the updated HTML content with fixed image tags.
</p>

</section>
<section id="toc136">
<h3>5.5.15. Fix Image Styles</h3>

<pre>
function fix_img_style($html)
</pre>

<p>
This function processes CSS `style` attributes in HTML elements to replace non-inline image URLs
within `url()` properties with a placeholder image (`<span class="underline">GIF_IMAGE</span>`).
</p>

<ul>
<li>@html =&gt; The HTML content to process.
</li>
</ul>

<p>
Returns the updated HTML content with fixed image styles.
</p>

</section>
<section id="toc137">
<h3>5.5.16. Fix Image Backgrounds</h3>

<pre>
function fix_img_background($html)
</pre>

<p>
This function processes `background` attributes in HTML elements to replace non-inline image URLs
with a placeholder image (`<span class="underline">GIF_IMAGE</span>`).
</p>

<ul>
<li>@html =&gt; The HTML content to process.
</li>
</ul>

<p>
Returns the updated HTML content with fixed image backgrounds.
</p>

</section>
<section id="toc138">
<h3>5.5.17. Fix Base64-Encoded Files</h3>

<pre>
function fix_file_b64($html)
</pre>

<p>
This function replaces inline base64-encoded file data in HTML with the corresponding
cached image content, ensuring that embedded images are properly handled.
</p>

<ul>
<li>@html =&gt; The HTML content to process.
</li>
</ul>

<p>
Return the updated HTML content with fixed base64-encoded files.
</p>
<p>
Notes:
</p>
<p>
We are using `{48}` to match base64 data of 48 bytes, which decodes into a 36-byte string
that matches the MD5 hash style used in cached files (32 bytes plus 4-byte `.b64` extension).
</p>

</section>
</section>
<section id="toc139">
<h2>5.6. Make indexing action</h2>

<pre>
apps/emails/php/indexing.php
</pre>

<p>
This fie contains useful functions related to the indexing action that internally uses the
mroonga engine to search in the fulltext string generated by this action
</p>

</section>
<section id="toc140">
<h2>5.7. Send email library</h2>

<pre>
apps/emails/php/sendmail.php
</pre>

<p>
This library provides the necesary functions to send emails.
</p>

<section id="toc141">
<h3>5.7.1. Used libraries</h3>

<pre>
use PHPMailer\PHPMailer\PHPMailer;
</pre>

<p>
This use loads the external libraries needed to run this library.
</p>

</section>
<section id="toc142">
<h3>5.7.2. Sendmail</h3>

<pre>
function sendmail($account_id, $to, $subject, $body, $files = '', $async = true)
</pre>

<p>
This function send an email in synchronous and/or asynchronous mode
</p>
<p>
$account_id =&gt; the account id used to detect the source of the email
$to         =&gt; can be an string with the destination email or an array with
               the follow prefixes =&gt; to:, cc:, bcc:, crt:, priority:,
               sensitivity:, replyto
$subject    =&gt; the subject string
$body       =&gt; the body string
$files      =&gt; an array with files
</p>
<p>
Notes:
</p>
<p>
This function must return the last_id if success, and a string if error
</p>

</section>
<section id="toc143">
<h3>5.7.3. Debugoutput helper</h3>

<pre>
function __sendmail_debugoutput_helper($str, $level)
</pre>

<p>
This function tries to echoed all debug information with the SMTP Error: prefix,
with this feature we can capture smtp errors with more details like the error
stored in $mail-&gt;ErrorInfo that always contains SMTP connect() failed, the signature
of this function will accomplish the neested callback arguments
</p>

<ul>
<li>@str   =&gt; the debug trace string that can contain the errors
</li>
<li>@level =&gt; unused in this function
</li>
</ul>

</section>
<section id="toc144">
<h3>5.7.4. Parser</h3>

<pre>
function __sendmail_parser($oldaddr)
</pre>

<p>
This function gets an address and tries to detect the name part and the addr
part of the argument. It's returns an array with two elements, the first is
for the addr and the second is for the name.
</p>

<ul>
<li>@oldaddr =&gt; the string that must to be processed
</li>
</ul>

</section>
<section id="toc145">
<h3>5.7.5. Message Id</h3>

<pre>
function __sendmail_messageid($account_id, $from)
</pre>

<p>
This function returns the message id for a new email, to do it, tries
to detect the outbox directory, compute an aproximation to the newest
value and checks that is unique in the system to prevent concurrence.
</p>

<ul>
<li>@account_id =&gt; the account id used to send the new email
</li>
<li>@from       =&gt; the from used to compute the crc32
</li>
</ul>

</section>
<section id="toc146">
<h3>5.7.6. Eml saver</h3>

<pre>
function __sendmail_emlsaver($message, $messageid)
</pre>

<p>
This function is intended to save the RFC822 message into the eml gzfile
</p>

<ul>
<li>@message   =&gt; the contents in RFC822 format of the message
</li>
<li>@messageid =&gt; the message id computed previously
</li>
</ul>

</section>
<section id="toc147">
<h3>5.7.7. Obj saver</h3>

<pre>
function __sendmail_objsaver($mail, $messageid)
</pre>

<p>
This function is intended to save the PHPMailer object into the obj file
</p>

<ul>
<li>@mail      =&gt; the PHPMailer object of the asynchronous transaction
</li>
<li>@messageid =&gt; the message id computed previously
</li>
</ul>

</section>
<section id="toc148">
<h3>5.7.8. Prepare email for sending</h3>

<pre>
function sendmail_prepare($action, $email_id)
</pre>

<p>
This function constructs the required parameters for sending an email, including sender details,
recipients, subject, body, and attachments. The behavior varies based on the specified action
(`reply`, `replyall`, or `forward`). It retrieves necessary data from the database and processes
the email's metadata to ensure compatibility with the given action.
</p>

<ul>
<li>@action   =&gt; Specifies the action to perform (`reply`, `replyall`, or `forward`).
</li>
<li>@email_id =&gt; ID of the email being replied to, forwarded, or used for metadata.
</li>
</ul>

<p>
Return the prepared email parameters, including sender, recipients, subject, body, state, and attachments.
</p>

</section>
<section id="toc149">
<h3>5.7.9. Perform email sending action</h3>

<pre>
function sendmail_action($json, $action, $email_id)
</pre>

<p>
This function handles the process of sending an email, including assembling email data,
recipients, and attachments. It also manages inline images, updates email states, and
cleans up temporary files after execution. The function supports multiple actions such
as `reply`, `replyall`, and `forward`.
</p>

<ul>
<li>@json     =&gt; JSON object containing email data (e.g., recipients, subject, body, attachments).
</li>
<li>@action   =&gt; Specifies the action to perform (`reply`, `replyall`, or `forward`).
</li>
<li>@email_id =&gt; ID of the email being replied to, forwarded, or used for metadata.
</li>
</ul>

<p>
Returns the status and message of the email action.
</p>

</section>
<section id="toc150">
<h3>5.7.10. Send queued emails from the server</h3>

<pre>
function sendmail_server()
</pre>

<p>
This function processes and sends emails queued in the outbox. It uses a semaphore mechanism
to prevent simultaneous execution, handles SMTP settings dynamically, updates email states,
and manages errors during the sending process. The function is intended for use in cron jobs.
</p>

<ul>
<li>@return array Returns an array of messages detailing the sending result, including errors and successes.
</li>
</ul>

</section>
<section id="toc151">
<h3>5.7.11. Retrieve email attachments</h3>

<pre>
function sendmail_files($action, $email_id)
</pre>

<p>
This function handles the retrieval of email attachments based on the specified action,
such as `forward`. It validates permissions, decodes the message, and stores attachments
locally if not already uploaded. Finally, it retrieves a list of attachments from the upload table.
</p>

<ul>
<li>@action   =&gt; Specifies the email action (`forward` in this case).
</li>
<li>@email_id =&gt; ID of the email to retrieve attachments from.
</li>
</ul>

<p>
Returns a list of attachments with metadata including ID, app, name, size, type, and hash.
</p>

</section>
<section id="toc152">
<h3>5.7.12. Update email signature, CC, and encryption state</h3>

<pre>
function sendmail_signature($json)
</pre>

<p>
This function updates the email body with a new signature, adjusts the CC list,
and replaces the encryption state (`state_crt`) based on the selected account.
</p>

<ul>
<li>@json =&gt; JSON object containing email data and account information.
</li>
</ul>

<p>
Return the updated email body, CC list, and encryption state.
</p>

</section>
</section>
</section>
<section id="toc153">
<h1>6. Sales</h1>

<section id="toc154">
<h2>6.1. Invoices application</h2>

<pre>
apps/sales/js/invoices.js
</pre>

<p>
This application provides core functionalities for managing invoices, including creating,
editing, viewing, and exporting invoices in PDF format.
</p>

<section id="toc155">
<h3>6.1.1. Main object</h3>

<pre>
saltos.invoices = {};
</pre>

<p>
This object contains all SaltOS code related to invoice operations.
</p>

</section>
<section id="toc156">
<h3>6.1.2. Initialize the invoices application</h3>

<pre>
saltos.invoices.init = arg
</pre>

<p>
This method handles initialization tasks based on the type of operation (`view`, `create`, or `edit`).
It updates UI elements and attaches appropriate event listeners.
</p>

<ul>
<li>@arg =&gt; Specifies the type of operation to initialize.
</li>
</ul>

</section>
<section id="toc157">
<h3>6.1.3. Calculate the dynamic width for each column in the "lines" table.</h3>

<pre>
saltos.invoices.colWidths_lines = index
</pre>

<p>
This function returns the width for each column. For the first column (index 0),
it dynamically calculates the remaining space based on the container width minus
a fixed width (500px) reserved for other columns. For all other columns, it returns 100px.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc158">
<h3>6.1.4. Define cell configuration for each column in the "lines" table.</h3>

<pre>
saltos.invoices.cells_lines = (row, column, prop)
</pre>

<p>
This function provides per-column behavior:
</p>

<ul>
<li>Column 4: renders a dropdown with available tax values (from #alltaxes).
</li>
<li>Column 5: sets the cell as read-only (used for calculated values).
</li>
<li>Other columns: no special config.
</li>
</ul>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc159">
<h3>6.1.5. Calculate the dynamic width for each column in the "taxes" table.</h3>

<pre>
saltos.invoices.colWidths_taxes = index
</pre>

<p>
The first column (index 0) fills the available space minus 200px reserved for other columns.
All other columns get a fixed width of 100px.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc160">
<h3>6.1.6. Define cell configuration for each column in the "taxes" table.</h3>

<pre>
saltos.invoices.cells_taxes = (row, column, prop)
</pre>

<p>
All cells in this table are read-only.
</p>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc161">
<h3>6.1.7. Calculate equal column widths for the "totals" table.</h3>

<pre>
saltos.invoices.colWidths_totals = index
</pre>

<p>
The table is divided into 3 equal columns, based on the container width.
</p>

<ul>
<li>@index =&gt; Column index
</li>
</ul>

<p>
Returns the width in pixels
</p>

</section>
<section id="toc162">
<h3>6.1.8. Define cell configuration for the "totals" table.</h3>

<pre>
saltos.invoices.cells_totals = (row, column, prop)
</pre>

<p>
All cells in this table are read-only.
</p>

<ul>
<li>@row    =&gt; Row index
</li>
<li>@column =&gt; Column index
</li>
<li>@prop   =&gt; Column property name
</li>
</ul>

<p>
Returns the configuration object
</p>

</section>
<section id="toc163">
<h3>6.1.9. Handle and recalculate invoice line totals and tax breakdowns after user edits.</h3>

<pre>
saltos.invoices.afterChange_lines = (changes, source)
</pre>

<p>
This function is triggered after the user modifies any cell in the "lines" matrix
(invoice lines). It performs the following operations:
</p>

<ul>
<li>Ignores changes triggered by internal actions (non-`edit` sources).
</li>
<li>Validates and normalizes quantity, price, and discount values:
    <ul>
    <li>Ensures `line[1]`, `line[2]`, `line[3]` (qty, price, discount) are numeric.
    </li>
    <li>Defaults discount to 0 if empty but qty and price are valid.
    </li>
    </ul>
</li>
<li>Calculates the line total as: `qty × price × (1 - discount%)`, rounded to 2 decimals.
</li>
<li>Updates the lines grid to reflect computed values.
</li>
<li>Recomputes the taxes matrix:
    <ul>
    <li>Aggregates taxable bases per tax value (`line[4]`).
    </li>
    <li>Computes tax amount for each group: `base × (tax% / 100)`.
    </li>
    </ul>
</li>
<li>Rounds all tax results to 2 decimals and updates the taxes grid.
</li>
<li>Computes the totals matrix:
    <ul>
    <li>`subtotal` = sum of all taxable bases
    </li>
    <li>`tax` = sum of all tax amounts
    </li>
    <li>`total` = subtotal + tax
    </li>
    <li>Results are rounded and shown in the totals grid.
    </li>
    </ul>
</li>
</ul>

<ul>
<li>@changes =&gt; Array of cell changes from the spreadsheet component
</li>
<li>@source  =&gt; Source of the change event (only `'edit'` triggers processing)
</li>
</ul>

</section>
</section>
<section id="toc164">
<h2>6.2. ChartJS widgets for invoices</h2>

<pre>
apps/sales/php/chartjs.php
</pre>

<p>
This file contains helper functions that generate Chart.js-compatible
datasets for visualizing invoice-related data within SaltOS4.
</p>
<p>
Each function returns an associative array with 'labels' and 'datasets',
directly usable by `&lt;chartjs&gt;` widgets in the XML layout system.
</p>
<p>
The metrics provided include:
</p>

<ul>
<li>Daily total invoicing
</li>
<li>Daily average invoice value
</li>
<li>Top 5 customers by total invoiced
</li>
<li>Count of paid vs unpaid invoices
</li>
<li>Average number of days to get paid
</li>
</ul>

<p>
All functions rely on data from the `app_invoices` table and assume
only closed invoices (`is_closed = 1`) are relevant.
</p>

<section id="toc165">
<h3>6.2.1. compute_invoice_total_by_day</h3>

<pre>
function compute_invoice_total_by_day()
</pre>

<p>
Computes the total invoiced amount per day, for closed invoices.
Useful for displaying the evolution of total income over time.
</p>
<p>
Returns a Chart.js-compatible array with labels (dates) and a single dataset (total per day).
</p>

</section>
<section id="toc166">
<h3>6.2.2. compute_invoice_avg_by_day</h3>

<pre>
function compute_invoice_avg_by_day()
</pre>

<p>
Computes the average invoice amount per day, considering only closed invoices.
This helps analyze how invoice sizes vary over time.
</p>
<p>
Returns a Chart.js-compatible array with labels (dates) and a single dataset (average amount).
</p>

</section>
<section id="toc167">
<h3>6.2.3. compute_top5_customers_by_total</h3>

<pre>
function compute_top5_customers_by_total()
</pre>

<p>
Retrieves the top 5 customers based on total invoiced amount for closed invoices.
Cuts customer names using `intelligence_cut()` for chart readability.
</p>
<p>
Returns a Chart.js-compatible array: labels (customer names) and one dataset (total invoiced).
</p>

</section>
<section id="toc168">
<h3>6.2.4. compute_invoice_paid_vs_pending</h3>

<pre>
function compute_invoice_paid_vs_pending()
</pre>

<p>
Counts how many closed invoices have been paid or are still unpaid.
Produces a pie chart data structure separating "Paid" and "Unpaid".
</p>
<p>
Returns a Chart.js-compatible array: labels (Paid/Unpaid) and one dataset (count of invoices).
</p>

</section>
<section id="toc169">
<h3>6.2.5. compute_invoice_avg_days_to_pay</h3>

<pre>
function compute_invoice_avg_days_to_pay()
</pre>

<p>
Calculates the average number of days it takes to get paid, based on the difference
between invoice and payment dates, grouped by payment day.
</p>
<p>
Returns a Chart.js-compatible array: labels (payment dates) and one dataset (average days to pay).
</p>

</section>
</section>
<section id="toc170">
<h2>6.3. Reverses the process of `make_matrix_data()` for the `invoices` app.</h2>

<pre>
apps/sales/php/invoices.php
</pre>

<p>
This function takes a previously generated matrix-style array of invoice data
(grouped as lines, taxes, and totals), compares it with the current values
in the database, and builds a minimal diff-like array that includes only
the fields that have changed, been removed, or added.
</p>

<section id="toc171">
<h3>6.3.1. unmake_matrix_data</h3>

<pre>
function unmake_matrix_data($json, $invoice_id)
</pre>

<p>
Reverse the matrix-encoded invoice data to a diff-style data array.
</p>

<ul>
<li>@json       =&gt; The matrix-encoded invoice data (from make_matrix_data)
</li>
<li>@invoice_id =&gt; The invoice ID used to retrieve the original data
</li>
</ul>

<p>
Return a diff array representing only the differences between the provided
data and the current state of the database.
</p>

</section>
<section id="toc172">
<h3>6.3.2. Generates or completes proforma and final invoice metadata.</h3>

<pre>
function set_proforma_invoice($json, $invoice_id)
</pre>

<p>
This function ensures that the given invoice JSON structure has appropriate values for:
</p>

<ul>
<li>`proforma_code` and `proforma_date` (if not provided or if it's a new invoice)
</li>
<li>`invoice_code` and `invoice_date` (if the invoice is being closed)
</li>
<li>`is_closed` (based on database if not explicitly set)
</li>
<li>`paid_date` (if the invoice is marked as paid)
</li>
<li>`due_date` (if the invoice is marked as closed)
</li>
</ul>

<p>
Rules:
</p>

<ul>
<li>If no `invoice_id` is given or `proforma_code` is not defined, a new proforma number is generated.
</li>
<li>If the invoice is being closed (`is_closed` is true), a new invoice number is generated.
</li>
<li>If `is_closed` is not defined in the JSON, it's looked up in the database for the given invoice ID.
</li>
<li>If `is_paid` is true and no `paid_date` is set, the current date is assigned.
</li>
<li>If the invoice is closed and no `due_date` is set, the current date is assigned.
</li>
</ul>

<ul>
<li>@json       =&gt; Invoice data to process and complete.
</li>
<li>@invoice_id =&gt; ID of the invoice, used to retrieve current status from DB.
</li>
</ul>

<p>
Return the updated JSON with appropriate codes and dates filled in.
</p>

</section>
</section>
</section>
<section id="toc173">
<h1>7. Tester</h1>

<section id="toc174">
<h2>7.1. Tester application</h2>

<pre>
apps/tester/js/tester.js
</pre>

<p>
This application implements the typical features associated with a tester,
showcasing functionalities such as modals, toasts, and offcanvas elements.
</p>

<section id="toc175">
<h3>7.1.1. Tester object</h3>

<pre>
saltos.tester = {};
</pre>

<p>
This object stores all the functions used by the Tester application,
providing the necessary methods for interaction and testing features.
</p>

</section>
<section id="toc176">
<h3>7.1.2. Campo 8: Alert functionality</h3>

<pre>
saltos.tester.campo8 = ()
</pre>

<p>
This function triggers a simple alert box when called, showcasing a button-click behavior.
</p>

</section>
<section id="toc177">
<h3>7.1.3. Campo 9: Modal functionality</h3>

<pre>
saltos.tester.campo9 = ()
</pre>

<p>
This function displays a Bootstrap modal with a title, body, and footer. The modal includes:
</p>

<ul>
<li>Text placeholders for content.
</li>
<li>A dropdown menu for additional options.
</li>
<li>Footer buttons to accept or cancel actions, with corresponding console logs.
</li>
</ul>

</section>
<section id="toc178">
<h3>7.1.4. Campo 10: Offcanvas functionality</h3>

<pre>
saltos.tester.campo10 = ()
</pre>

<p>
This function displays a Bootstrap offcanvas element with a title and body content.
The body includes:
</p>

<ul>
<li>Text placeholders for content.
</li>
<li>A dropdown menu for additional options.
</li>
</ul>

</section>
<section id="toc179">
<h3>7.1.5. Campo 11: Toast functionality</h3>

<pre>
saltos.tester.campo11 = ()
</pre>

<p>
This function displays a Bootstrap toast notification with customizable attributes, including:
</p>

<ul>
<li>A title and subtitle for context.
</li>
<li>Body content with dynamic timestamp information.
</li>
</ul>

</section>
<section id="toc180">
<h3>7.1.6. Campo 22: Open statistics page</h3>

<pre>
saltos.tester.campo23 = ()
</pre>

<p>
This function opens the SaltOS statistics page in a new browser tab or window.
</p>

</section>
</section>
</section>
<section id="toc181">
<h1>8. Users</h1>

<section id="toc182">
<h2>8.1. Login application</h2>

<pre>
apps/users/js/login.js
</pre>

<p>
This application implements the tipical features associated to login
</p>

<section id="toc183">
<h3>8.1.1. Main object</h3>

<pre>
saltos.login = {};
</pre>

<p>
This object contains all SaltOS code
</p>

</section>
<section id="toc184">
<h3>8.1.2. Authenticate login function</h3>

<pre>
saltos.login.authenticate = async ()
</pre>

<p>
This function tries to authenticate the user using the user and pass fields of the form, to do
it uses the authenticate function that send data to the authtoken action
</p>

</section>
</section>
<section id="toc185">
<h2>8.2. Days functions</h2>

<pre>
apps/users/php/days.php
</pre>

<p>
This file contain all functions needed by the days feature
</p>

<section id="toc186">
<h3>8.2.1. Days to bin</h3>

<pre>
function days2bin($days)
</pre>

<p>
This function tries to convert the days format used by the multiselect
to the string expected by the database formed by ones and zeroes to
represent if a day is operative for the user or not, for example, the
selection 64,32,16,8,4 is returned like from monday to friday (1111100)
</p>

<ul>
<li>@days =&gt; the string containing the days in power of two separated by comma
</li>
</ul>

</section>
<section id="toc187">
<h3>8.2.2. Bin to days</h3>

<pre>
function bin2days($days)
</pre>

<p>
This function tries to do the reverse action that the previous function,
is able to get an string like 1111100 and returns the list of all bits in
decimal like 64,32,16,8,4.
</p>

<ul>
<li>@days =&gt; the string containing the days in binary format
</li>
</ul>

</section>
<section id="toc188">
<h3>8.2.3. Fix for days</h3>

<pre>
function fix4days($data)
</pre>

<p>
This function is intended to be used as wrapper in the result of the query
that contains an element called days, in the database the days is stored
using the binary notation like 1111100, and for the user interface, is needed
to translate this string into a decimal string like 64,32,16,8,4.
</p>

<ul>
<li>@data =&gt; the data obtained from an execute_query, for example, they must contain
         an entry called days.
</li>
</ul>

</section>
</section>
<section id="toc189">
<h2>8.3. Groups functions</h2>

<pre>
apps/users/php/groups.php
</pre>

<p>
This file contain all functions needed by the groups app
</p>

<section id="toc190">
<h3>8.3.1. Insert group action</h3>

<pre>
function insert_group($data)
</pre>

<p>
This action allow to insert registers in the database associated to
the groups app and only requires the data.
</p>

<ul>
<li>@data =&gt; the array with all data used to create the new group
</li>
</ul>

</section>
<section id="toc191">
<h3>8.3.2. Update group action</h3>

<pre>
function update_group($group_id, $data)
</pre>

<p>
This action allow to update registers in the database associated to
the groups app and requires the group_id and data.
</p>

<ul>
<li>@group_id =&gt; the group_id desired to be updated
</li>
<li>@data     =&gt; the array with all data used to update the group
</li>
</ul>

</section>
<section id="toc192">
<h3>8.3.3. Delete group action</h3>

<pre>
function delete_group($group_id)
</pre>

<p>
This action allow to delete registers in the database associated to
the groups app and only requires the group_id.
</p>

<ul>
<li>@group_id =&gt; the group_id desired to be deleted
</li>
</ul>

</section>
</section>
<section id="toc193">
<h2>8.4. Matrix functions</h2>

<pre>
apps/users/php/matrix.php
</pre>

<p>
This file contains all the functions required by the Excel widget for handling
permissions and applications in a matrix structure.
</p>

<section id="toc194">
<h3>8.4.1. Create matrix data</h3>

<pre>
function make_matrix_data($perms, $apps, $main, $user)
</pre>

<p>
This function generates a matrix of permissions and applications, associating each
application with its respective permissions and their assigned values ("Allow", "Deny", or "").
</p>

</section>
<section id="toc195">
<h3>8.4.2. Create matrix cells</h3>

<pre>
function make_matrix_cell($perms, $apps, $main, $user)
</pre>

<p>
This function generates matrix cells with additional attributes such as column and row indices,
and dropdown options for editing cell values. Read-only attributes are applied to specific cells.
</p>

</section>
<section id="toc196">
<h3>8.4.3. Unmake matrix data</h3>

<pre>
function unmake_matrix_data($perms, $apps, $main, $json)
</pre>

<p>
This function reverses the matrix data into a more manageable format by applying
permission and application mappings while validating data consistency.
</p>

</section>
<section id="toc197">
<h3>8.4.4. Generate matrix permissions</h3>

<pre>
function make_matrix_perms($table, $field, $id)
</pre>

<p>
This function generates the complete matrix data and metadata for use in
the Excel widget, including column headers, row headers, data values, and cell details.
</p>

</section>
</section>
<section id="toc198">
<h2>8.5. Users functions</h2>

<pre>
apps/users/php/users.php
</pre>

<p>
This file contain all functions needed by the users app
</p>

<section id="toc199">
<h3>8.5.1. Insert user action</h3>

<pre>
function insert_user($data)
</pre>

<p>
This action allow to insert registers in the database associated to
the users app and only requires the data.
</p>

<ul>
<li>@data =&gt; the array with all data used to create the new user
</li>
</ul>

</section>
<section id="toc200">
<h3>8.5.2. Update user action</h3>

<pre>
function update_user($user_id, $data)
</pre>

<p>
This action allow to update registers in the database associated to
the users app and requires the user_id and data.
</p>

<ul>
<li>@user_id =&gt; the user_id desired to be updated
</li>
<li>@data    =&gt; the array with all data used to update the user
</li>
</ul>

</section>
<section id="toc201">
<h3>8.5.3. Delete user action</h3>

<pre>
function delete_user($user_id)
</pre>

<p>
This action allow to delete registers in the database associated to
the users app and only requires the user_id.
</p>

<ul>
<li>@group_id =&gt; the user_id desired to be deleted
</li>
</ul>

</section>
</section>
</section>
</div>
<!-- html code generated by txt2tags 3.4 (http://txt2tags.org) -->
<!-- cmdline: txt2tags -\-toc -t html -i apps.t2t -o apps.html -->
</article></body></html>
